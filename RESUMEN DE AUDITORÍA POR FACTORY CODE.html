<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen de Auditor√≠a por Factory Code</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- jQuery + Select2 para multi-select amigable -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* Select2 visual tweaks to match reference (rounded box, checkboxes in dropdown) */
        .select2-container--default .select2-selection--multiple,
        .select2-container--default .select2-selection--single {
            border-radius: 12px;
            min-height: 36px; /* reduced height */
            padding: 6px 8px; /* reduced padding for a tighter look */
            border: 2px solid #ececec;
            background: #fff;
            box-shadow: none;
        }

        /* function populateYearSelect moved to script helpers (avoid embedding JS inside <style>) */

        .select2-selection__rendered {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #333;
            font-size: 10px; /* kept calibri 10 as requested */
            line-height: 1;
            padding: 0; /* ensure compact rendering */
        }

        /* Hide the tokenized choices, we will render a compact summary */
        .select2-selection__choice {
            display: none;
        }

        .select2-placeholder { color: #8b8b8b; }

        .select2-dropdown {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.06);
            padding: 8px;
        }

        .select2-results__options {
            max-height: 260px;
            overflow-y: auto;
            padding: 2px;
        }

        .select2-results__option {
            padding: 6px 10px !important;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border-radius: 6px;
        }

        .select2-results__option--highlighted {
            background: #eaf6ff !important;
        }

        .s2-checkbox {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #cfd8dd;
            background: #fff;
            accent-color: #1e88e5;
            flex-shrink: 0;
        }

        .select2-results__option[aria-selected="true"] { background: #eaf6ff; }

        .select2-search--dropdown .select2-search__field {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
            width: 100%;
            box-sizing: border-box;
        }

        /* Force dropdown option text to Calibri 10 bold */
        .s2-label,
        .select2-container--default .select2-results__option .s2-label,
        .select2-container--default .select2-results__option .s2-result .s2-label {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 10px !important;
            font-weight: 700 !important;
            color: #111 !important;
        }

        /* Ensure the control's displayed summary uses Calibri 10 bold */
        .select2-container--default .select2-selection__rendered,
        .select2-container--default .select2-selection__rendered .select2-placeholder {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 10px !important;
            font-weight: 700 !important;
            color: #222 !important;
        }

        /* Scrollbar styling for dropdown (WebKit) */
        .select2-results__options::-webkit-scrollbar { width: 10px; }
        .select2-results__options::-webkit-scrollbar-track { background: transparent; }
        .select2-results__options::-webkit-scrollbar-thumb { background: #e6f0fa; border-radius: 10px; }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #ffffff;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .controls-left {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        #loadingStatus {
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-family: Calibri, Arial, sans-serif;
            display: inline-block;
        }

        /* Badge-style variants (compatible with existing class names: loading, success, error).
           JS will preserve the 'badge' base class when switching states. */
        .badge.loading {
            background-color: #fff8e1;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .badge.success {
            background-color: #e6ffef;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge.error {
            background-color: #fff0f0;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .badge .check { display:inline-block; margin-left:8px; padding:2px 6px; border-radius:12px; background:#def7e0; color:#155724; font-weight:700 }

        #error-banner {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #fee2e2;
            color: #991b1b;
            border-bottom: 1px solid #fecaca;
            padding: 10px 16px;
            font-size: 14px;
            display: none;
            z-index: 3000;
            text-align: center;
        }

        #loadingStatus {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
        }

        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #error-banner {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #fee2e2;
            color: #991b1b;
            border-bottom: 1px solid #fecaca;
            padding: 10px 16px;
            font-size: 14px;
            display: none;
            z-index: 3000;
            text-align: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            font-size: 14px;
            color: #555;
        }

        input[type="file"],
        select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: #fff;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        input[type="file"]:hover,
        select:hover {
            border-color: #4A90E2;
        }

        select {
            min-width: 200px;
        }

        #weekSelect {
            min-width: 80px;
            width: 80px;
        }

        .btn-download {
            padding: 8px 14px;
            background-color: #FF9800;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-download:hover {
            background-color: #F57C00;
        }

        .btn-download:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-chart {
            padding: 8px 14px;
            background-color: #4A90E2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .btn-chart:hover {
            background-color: #357ABD;
        }

        .btn-chart:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .buttons-container {
            display: flex;
            align-items: center;
        }

        /* Header wrapper so we can place the back button at the right of the title */
        .header {
            position: relative;
            margin-bottom: 10px;
        }

        .header h1 {
            margin-bottom: 0;
        }

        .back-btn-h1 {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-family: Calibri, Arial, sans-serif;
            font-size: 13px;
            margin-left: 8px;
            padding: 6px 10px;
            background: #001a54;
            color: #fff;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 700;
            display: inline-block;
        }

        /* Slightly smaller badge for loading status inside the reduced controls */
        #loadingStatus {
            font-size: 12px;
            padding: 6px 10px;
        }

        /* Ajustes para reducir tama√±o de los elementos internos al ~80% visualmente */
        .control-fieldset {
            padding: 10px; /* ligeramente menor */
        }

        .control-fieldset legend {
            font-size: 13px;
        }

        .fieldset-content {
            gap: 10px;
        }

        select, input[type="file"] {
            padding: 8px 10px;
            font-size: 12px;
            min-width: 140px;
        }

        #weekSelect {
            min-width: 70px;
            width: 70px;
            font-size: 12px;
            padding: 6px 8px;
        }

        .switch {
            width: 42px;
            height: 22px;
            transform: scale(0.9); /* reducir al 90% visualmente */
            transform-origin: 0 50%;
            display: inline-block;
            margin-right: 2px;
        }

        .slider:before {
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
        }

        input:checked + .slider:before {
            transform: translateX(18px); /* ajustado para escala 0.9 */
        }

        .switch-label {
            font-size: 12px;
        }

        .control-group label {
            font-size: 12px;
            font-family: Calibri, Arial, sans-serif;
        }

        /* Slightly tighten buttons further if needed */
        .btn-download, .btn-chart {
            padding: 7px 12px;
            font-size: 12px;
            font-family: Calibri, Arial, sans-serif;
        }

        /* Aplicar Calibri 12px a elementos dentro de la zona de controles */
        .controls select,
        .controls .switch-label,
        .controls .control-fieldset,
        .controls .control-group,
        .controls .control-fieldset legend,
        .controls .buttons-container button,
        .controls .buttons-container .badge,
        .controls .buttons-container a {
            font-family: Calibri, Arial, sans-serif;
            font-size: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none; /* hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        /* Show modal when .open is present and center content */
        .modal.open {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px; /* reduced padding to fit viewport better */
            overflow-y: auto; /* allow scrolling when content taller than viewport */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 0 auto;
            padding: 12px; /* slightly reduced */
            border: none;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            /* Ensure modal content never exceeds viewport height */
            max-height: calc(100vh - 20px);
            overflow: auto; /* internal scrolling for tall content */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .chart-container {
            position: relative;
            height: 320px; /* reduced height to avoid modal vertical scroll */
            margin-top: 8px; /* less gap above chart */
        }

        .modal h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 24px;
        }

        .table-section {
            margin-bottom: 50px;
        }

        .table-section h2 {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4A90E2;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            position: relative;
        }

        /* Scaled wrapper to reduce visual size of large tables to ~78%.
           Use `zoom` on Chromium-based browsers to preserve `position: sticky`
           and avoid creating extra horizontal/vertical whitespace.
           A lightweight fallback for Firefox keeps layout usable but may differ. */
        .table-wrapper.scaled-wrapper {
            /* reduce visible max height proportionally */
            max-height: 468px; /* 600px * 0.78 */
            padding: 0; /* reduce extra spacing around table */
        }

        /* Primary (Chromium): use `zoom` which visually scales but keeps
           sticky headers and scroll behavior intact in most browsers like Chrome/Edge. */
        .table-wrapper.scaled-wrapper > table {
            zoom: 0.78; /* supported by Chromium/Edge */
            transform: none; /* ensure transform is not used */
            width: 100%;
            margin: 0; /* remove unexpected gaps */
        }

        /* Fallback for Firefox: `zoom` is unsupported there, so use transform
           but avoid width compensation which caused large empty scrollable areas.
           Note: transform can affect `position: sticky` in Firefox; if that
           happens we can switch to adjusting font-size/padding instead. */
        @supports (-moz-appearance: none) {
            .table-wrapper.scaled-wrapper > table {
                zoom: unset;
                transform: scale(0.78);
                transform-origin: 0 0;
                width: auto;
            }
        }

        /* Prevent oversized internal spacing that made scrollbars very long */
        .table-wrapper > table, .table-wrapper > table tbody, .table-wrapper > table thead {
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            font-size: 13px;
            table-layout: fixed;
        }

        thead {
            background-color: #E3F2FD;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 12px 10px;
            text-align: center;
            font-weight: 700;
            color: #1a1a1a;
            border: 1px solid #B3D9FF;
            white-space: normal;
            word-wrap: break-word;
            min-width: 100px;
            width: 100px;
            max-width: 100px;
            background-color: #E3F2FD;
        }

        th:nth-child(1) {
            min-width: 120px;
            width: 120px;
            max-width: 120px;
        }

        th:nth-child(2) {
            min-width: 120px;
            width: 120px;
            max-width: 120px;
        }

        th:nth-child(n+3):nth-child(-n+21) {
            min-width: 65px !important;
            width: 65px !important;
            max-width: 65px !important;
        }

        th:nth-child(5),
        th:nth-child(6) {
            min-width: 50px !important;
            width: 50px !important;
            max-width: 50px !important;
        }

        th:nth-child(22),
        th:nth-child(23),
        th:nth-child(24),
        th:nth-child(25) {
            min-width: 50px;
            width: 50px;
            max-width: 50px;
        }

        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
            white-space: normal;
            word-wrap: break-word;
            min-width: 100px;
            width: 100px;
            max-width: 100px;
        }

        td:nth-child(1) {
            min-width: 120px;
            width: 120px;
            max-width: 120px;
        }

        td:nth-child(2) {
            min-width: 120px;
            width: 120px;
            max-width: 120px;
        }

        td:nth-child(n+3):nth-child(-n+21) {
            min-width: 65px !important;
            width: 65px !important;
            max-width: 65px !important;
        }

        td:nth-child(5),
        td:nth-child(6) {
            min-width: 50px !important;
            width: 50px !important;
            max-width: 50px !important;
        }

        td:nth-child(22),
        td:nth-child(23),
        td:nth-child(24),
        td:nth-child(25) {
            min-width: 50px;
            width: 50px;
            max-width: 50px;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #f0f7ff;
        }

        .total-row {
            font-weight: 700;
            background-color: #f5f5f5 !important;
        }

        .total-row td:first-child {
            text-align: left;
            padding-left: 20px;
        }

        .highlight-yellow {
            background-color: #FFEB3B !important;
            font-weight: 700;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        /* Switch Toggle Styles */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .switch-label {
            font-weight: 600;
            font-size: 14px;
            color: #555;
            user-select: none;
        }

        /* Fieldset styles for grouping */
        .control-fieldset {
            border: 1px solid #ddd; /* marco m√°s delgado */
            border-radius: 6px;
            padding: 8px 10px; /* menos espacio interno */
            margin: 0 8px 0 0;
            background-color: #fafafa;
            display: inline-block; /* ajusta al contenido */
            vertical-align: middle;
            min-width: 0;
        }

        .control-fieldset legend {
            font-weight: 600;
            font-size: 12px; /* leyenda m√°s peque√±a */
            color: #333;
            padding: 0 6px; /* menos padding alrededor del texto */
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 4px;
            line-height: 1;
        }

        .fieldset-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        /* Ajustes espec√≠ficos para el fieldset Week: hacerlo m√°s corto y acercar switch+label */
        #weekFieldset {
            max-width: 380px;
            min-width: 0;
        }
        /* Mantener los controles en una sola l√≠nea y compactarlos */
        #weekFieldset .fieldset-content {
            gap: 1px;
            flex-wrap: nowrap;
            align-items: center;
        }
        /* Reducir espacio espec√≠ficamente entre A√±o (1) y Sem/Mes (2) */
        #weekFieldset .fieldset-content > .control-group:nth-of-type(1) {
            margin-right: 2px; /* acercar Sem/Mes a A√±o */
        }
        /* Mostrar cada control-group en fila para que todos queden alineados */
        #weekFieldset .control-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 6px;
            margin: 0;
        }
        #weekFieldset .control-group select,
        #weekFieldset .control-group input {
            margin: 0;
            padding: 6px 8px;
            font-size: 12px;
        }
        #weekFieldset .switch-container {
            gap: 0px; /* reducir espacio entre switch y label */
            align-items: center;
        }
        #weekFieldset .switch {
            margin-right: 4px;
        }
        #weekFieldset .switch-label {
            white-space: nowrap;
            margin-left: 1px;
            font-size: 12px;
        }
        #weekFieldset select {
            min-width: 56px; /* controles m√°s compactos dentro de Week */
        }
        /* Ajustar ancho del select de A√±o al 70% de su contenedor */
        #weekFieldset .fieldset-content > .control-group:nth-of-type(1) select {
            width: 100%;
            box-sizing: border-box;
            min-width: 0 !important; /* override global min-width */
            max-width: 100%;
        }
        /* Anchos exactos en porcentaje dentro del fieldset Week (suman 100%) */
        /* 1: A√±o ~26.32%, 2: Sem/Mes ~21.05%, 3: Week ~18.42%, 4: Switch+label ~34.21% */
        #weekFieldset .fieldset-content > .control-group:nth-of-type(1) {
            flex: 0 0 26.32%;
            max-width: 26.32%;
        }
        #weekFieldset .fieldset-content > .control-group:nth-of-type(2) {
            flex: 0 0 21.05%;
            max-width: 21.05%;
        }
        #weekFieldset .fieldset-content > .control-group:nth-of-type(3) {
            flex: 0 0 18.42%;
            max-width: 18.42%;
        }
        #weekFieldset .fieldset-content > .control-group:nth-of-type(4) {
            flex: 0 0 34.21%;
            max-width: 34.21%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        /* Hacer que los selects ocupen el ancho de su contenedor */
        #weekFieldset .control-group select {
            width: 100%;
            box-sizing: border-box;
        }
        /* Fallback: en pantallas peque√±as, volver a envolver */
        @media (max-width: 480px) {
            #weekFieldset .fieldset-content {
                flex-wrap: wrap;
            }
            #weekFieldset .fieldset-content > .control-group:nth-of-type(1),
            #weekFieldset .fieldset-content > .control-group:nth-of-type(2),
            #weekFieldset .fieldset-content > .control-group:nth-of-type(3),
            #weekFieldset .fieldset-content > .control-group:nth-of-type(4) {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="error-banner" role="alert" aria-live="assertive"></div>
    
    <div class="container">
        <div class="header">
            <h1>RESUMEN DE AUDITOR√çA POR FACTORY CODE</h1>
            <a href="index.html" class="back-btn-h1">‚Üê Volver</a>
        </div>

        <div class="controls">
            <div class="controls-left">
                <!-- Estado de carga: trasladado al lado derecho (junto a Gr√°ficos) para mostrar como badge -->
                
                <fieldset class="control-fieldset" id="weekFieldset">
                    <legend>Week:</legend>
                    <div class="fieldset-content">
                        <div class="control-group">
                            <select id="yearSelect" disabled>
                                <option value="">A√±o</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <select id="periodSelect">
                                <option value="Sem">Sem</option>
                                <option value="Mes">Mes</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <select id="weekSelect" disabled>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="lastWeekToggle">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-label">Last Week</span>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="control-fieldset">
                    <legend>Factory Filters:</legend>
                    <div class="fieldset-content">
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="cofacoToggle">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Cofaco</span>
                        </div>
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="cititex1Toggle">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Cititex 1</span>
                        </div>
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="cititex2Toggle">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label">Cititex 2</span>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="control-fieldset">
                    <legend>Customer Filter:</legend>
                    <div class="fieldset-content">
                        <div class="control-group">
                            <select id="customerFilter" disabled>
                                <option value="">Todos los Customers</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
            </div>
            
                <div class="buttons-container">
                <button id="btnDownload" class="btn-download" disabled>Descargar Excel</button>
                <button id="btnChart" class="btn-chart" disabled>üìä Gr√°ficos</button>
                <span id="loadingStatus" class="badge loading" style="margin-left:12px">Cargando datos desde Google Sheets...</span>
            </div>
        </div>

        <!-- Modal para la gr√°fica -->
        <div id="chartModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>Performance Auditorias Producto Terminado Internas</h2>
                
                <!-- L√≠nea separadora -->
                <hr style="margin: 15px 0; border: none; border-top: 2px solid #ddd; width: 100%;">
                
                <!-- Controles de filtrado con marco verde -->
                <div style="background-color: #e8f5e8; border: 2px solid #90c695; border-radius: 8px; padding: 8px; margin-bottom: 10px;">
                    <div style="text-align: center; display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                        <div>
                            <label for="chartCustomerFilter" style="font-weight: bold; margin-right: 8px;">Customer:</label>
                            <select id="chartCustomerFilter" style="padding: 6px 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 12px; width: 220px;">
                                <option value="">Todos los Customers</option>
                            </select>
                        </div>

                        <div>
                            <label for="factoryFilter" style="font-weight: bold; margin-right: 8px;">Factory Code:</label>
                            <select id="factoryFilter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 180px;">
                                <option value="all">Todos los Factory Codes</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="weekFromFilter" style="font-weight: bold; margin-right: 8px;">Desde:</label>
                            <select id="weekFromFilter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 100px;">
                            </select>
                        </div>
                        
                        <div>
                            <label for="weekToFilter" style="font-weight: bold; margin-right: 8px;">Hasta:</label>
                            <select id="weekToFilter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 100px;">
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="tablesContainer" class="hidden">
            <div class="table-section">
                <h2>INTERNA</h2>
                <div class="table-wrapper scaled-wrapper">
                    <table id="internaTable">
                        <thead>
                            <tr>
                                <th>Factory Code</th>
                                <th>Customer</th>
                                <th>Lot Size</th>
                                <th>Sample Size</th>
                                <th>Tot. Def.</th>
                                <th>Fabric</th>
                                <th>Untrimmed threads End</th>
                                <th>Embellisment</th>
                                <th>Hole</th>
                                <th>Broken/skip stitches</th>
                                <th>Color Shading</th>
                                <th>Puckering/Excessive Fullness</th>
                                <th>Cleaness</th>
                                <th>Asymmetrical</th>
                                <th>Pin</th>
                                <th>Wrong Hangtas</th>
                                <th>Assorment</th>
                                <th>Shipping Marks</th>
                                <th>Others</th>
                                <th>Meas.</th>
                                <th>Cuenta de N¬∫ Report</th>
                                <th>A1</th>
                                <th>A2</th>
                                <th>A3</th>
                                <th>A4</th>
                            </tr>
                        </thead>
                        <tbody id="internaBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-section">
                <h2>CLIENTE</h2>
                <div class="table-wrapper scaled-wrapper">
                    <table id="clienteTable">
                        <thead>
                            <tr>
                                <th>Factory Code</th>
                                <th>Customer</th>
                                <th>Lot Size</th>
                                <th>Sample Size</th>
                                <th>Tot. Def.</th>
                                <th>Fabric</th>
                                <th>Untrimmed threads End</th>
                                <th>Embellisment</th>
                                <th>Hole</th>
                                <th>Broken/skip stitches</th>
                                <th>Color Shading</th>
                                <th>Puckering/Excessive Fullness</th>
                                <th>Cleaness</th>
                                <th>Asymmetrical</th>
                                <th>Pin</th>
                                <th>Wrong Hangtas</th>
                                <th>Assorment</th>
                                <th>Shipping Marks</th>
                                <th>Others</th>
                                <th>Meas.</th>
                                <th>Cuenta de N¬∫ Report</th>
                            </tr>
                        </thead>
                        <tbody id="clienteBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="noDataMessage" class="no-data hidden">
            No hay datos para esta Week
        </div>
    </div>

    <script>
        // Google Sheets configuration
        // INSTRUCTIONS:
        // 1. Make sure your Google Sheet is publicly accessible (Share > Anyone with the link can view)
        // 2. Update SHEET_NAME below to match the exact tab name in your Google Sheet
        // 3. Ensure your sheet has the same column structure as the original Excel file
        const SHEET_ID = '1nEvl2vlYNC2SVOYTRXuij-0duWZ_Aw3NqyP-8Zi5raA';
        const SHEET_NAME = 'GRID'; // Change this to match your sheet tab name

        let gridData = [];
        let allWeeks = [];

        const weekSelect = document.getElementById('weekSelect');
        const yearSelect = document.getElementById('yearSelect');
        const periodSelect = document.getElementById('periodSelect');
        const tablesContainer = document.getElementById('tablesContainer');
        const noDataMessage = document.getElementById('noDataMessage');
        const internaBody = document.getElementById('internaBody');
        const clienteBody = document.getElementById('clienteBody');
        const btnDownload = document.getElementById('btnDownload');
        const btnChart = document.getElementById('btnChart');
        const lastWeekToggle = document.getElementById('lastWeekToggle');
        const cititex1Toggle = document.getElementById('cititex1Toggle');
        const cititex2Toggle = document.getElementById('cititex2Toggle');
        const cofacoToggle = document.getElementById('cofacoToggle');
        const customerFilter = document.getElementById('customerFilter');
        const loadingStatus = document.getElementById('loadingStatus');
        const errorBanner = document.getElementById('error-banner');
        const chartModal = document.getElementById('chartModal');
        const closeModal = document.getElementById('closeModal');
        const factoryFilter = document.getElementById('factoryFilter');
        const chartCustomerFilter = document.getElementById('chartCustomerFilter');
        const weekFromFilter = document.getElementById('weekFromFilter');
        const weekToFilter = document.getElementById('weekToFilter');

        let currentInternaData = [];
        let currentClienteData = [];
        let prevWeekSelection = null; // guarda la semana activa antes de activar "Last Week"

        // Helpers para manejar la columna 'Audit Date'
        function parseDateFromString(s) {
            if (!s) return null;
            s = String(s).trim();
            
            // Detectar y parsear formato Google Sheets GVIZ: Date(yyyy,m,d)
            const gvizMatch = s.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
            if (gvizMatch) {
                const year = parseInt(gvizMatch[1], 10);
                const month = parseInt(gvizMatch[2], 10); // 0-based (0=Jan) o 1-based?
                const day = parseInt(gvizMatch[3], 10);
                // Asumir que Google Sheets GVIZ usa 0-based month (0=January)
                return new Date(year, month, day);
            }
            
            // Intentar Date.parse (puede resolver ISO strings)
            const d = new Date(s);
            if (!isNaN(d.getTime())) return d;
            
            // Intentar formatos comunes con '/': ASUME mm/dd/yyyy por defecto (Google Sheets US)
            if (s.indexOf('/') !== -1) {
                const parts = s.split('/').map(p => p.trim());
                if (parts.length === 3) {
                    // Asumir mm/dd/yyyy (Google Sheets default US format)
                    let month = parseInt(parts[0], 10);
                    let day = parseInt(parts[1], 10);
                    let year = parseInt(parts[2], 10);
                    
                    // Validar: si mes > 12, intercambiar (era dd/mm/yyyy)
                    if (month > 12 && day <= 12) {
                        const temp = day;
                        day = month;
                        month = temp;
                    } else if (day > 12 && month <= 12) {
                        // day > 12 y month <= 12 => ya es dd/mm/yyyy, mantener como est√°
                    } else if (day > 31 || month > 31) {
                        return null;
                    }

                    if (year < 100) year += 2000;
                    return new Date(year, month - 1, day);
                }
            }
            
            // Intentar con '-' (yyyy-mm-dd)
            if (s.indexOf('-') !== -1) {
                const parts = s.split('-').map(p => p.trim());
                if (parts.length === 3) {
                    // Si primer parte tiene 4 d√≠gitos => yyyy-mm-dd
                    if (parts[0].length === 4) {
                        const y = parseInt(parts[0], 10);
                        const m = parseInt(parts[1], 10);
                        const d2 = parseInt(parts[2], 10);
                        return new Date(y, m - 1, d2);
                    }
                }
            }
            return null;
        }

        function getISOWeek(d) {
            // Copy date so don't modify original
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function monthNameES(m) {
            const names = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            return names[m];
        }

        function populateYearSelect() {
            const years = new Set();
            if (!gridData || gridData.length === 0) {
                if (yearSelect) yearSelect.disabled = true;
                return;
            }
            gridData.forEach(row => {
                const ad = row['Audit Date'];
                const dt = parseDateFromString(ad);
                if (!dt) return;
                years.add(String(dt.getFullYear()));
            });

            const arr = Array.from(years).map(y=>parseInt(y,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b).map(n=>String(n));
            if (!yearSelect) return;
            yearSelect.innerHTML = '<option value="">A√±o</option>';
            arr.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });
            yearSelect.disabled = (arr.length === 0);
        }

        // Cargar datos de ejemplo localmente para depuraci√≥n
        function loadSampleData() {
            const today = new Date(2025,11,13); // 13 Dec 2025 (context)
            const isoWeek = getISOWeek(today);
            const sample = [
                { 'Week': String(isoWeek), 'Audit Date': '12/13/2025', 'Customer': 'Banana', 'Lot Size': '1000', 'Sample Size': '50', 'Tot. Def.': '2', 'Intento': '1', 'Validez': 'Interna', 'Factory Code': 'Cititex 1' },
                { 'Week': '49', 'Audit Date': '12/4/2025', 'Customer': 'Lululemon', 'Lot Size': '8020', 'Sample Size': '200', 'Tot. Def.': '16', 'Intento': '2', 'Validez': 'Interna', 'Factory Code': 'Cofaco' },
                { 'Week': '49', 'Audit Date': '12/5/2025', 'Customer': 'Skechers', 'Lot Size': '309', 'Sample Size': '50', 'Tot. Def.': '1', 'Intento': '1', 'Validez': 'Cliente', 'Factory Code': 'Cititex 2' }
            ];
            try {
                processSheetData(sample);
                updateLoadingStatus('Datos de prueba cargados <span class="check">‚úì</span>', 'success');
            } catch (e) {
                console.error('Error al cargar datos de prueba', e);
                showError('No se pudieron cargar los datos de prueba. Ver consola.');
            }
        }

        // Helper: obtener lista de customers seleccionados (compatibilidad Select2 y select m√∫ltiple nativo)
        function getSelectedCustomers() {
            try {
                if (window.jQuery && $('#customerFilter').data('select2')) {
                    const val = $('#customerFilter').val() || [];
                    return val.filter(v => v !== null && v !== undefined && String(v).trim() !== '');
                }
            } catch (e) {
                // ignore
            }
            return Array.from(customerFilter.selectedOptions || [])
                .map(o => o.value)
                .filter(v => v !== null && v !== undefined && String(v).trim() !== '');
        }

        // Helper para el modal de gr√°fica (chartCustomerFilter)
        function getSelectedChartCustomers() {
            try {
                if (window.jQuery && $('#chartCustomerFilter').data('select2')) {
                    const val = $('#chartCustomerFilter').val() || [];
                    return val.filter(v => v !== null && v !== undefined && String(v).trim() !== '');
                }
            } catch (e) {}
            const el = document.getElementById('chartCustomerFilter');
            if (!el) return [];
            return Array.from(el.selectedOptions || []).map(o => o.value).filter(v => v !== null && v !== undefined && String(v).trim() !== '');
        }

        // Inicializar Select2 (se mantendr√° deshabilitado hasta poblar opciones)
        if (window.jQuery) {
            $(function() {
                $('#customerFilter').attr('multiple', 'multiple');
                $('#customerFilter').select2({
                    placeholder: 'Seleccione Customers',
                    allowClear: true,
                    width: 'resolve',
                    closeOnSelect: false,
                    templateResult: function(state) {
                        if (!state.id) return state.text;
                        var checked = state.selected ? 'checked' : '';
                        var $state = $("<div class='s2-result'><input type='checkbox' class='s2-checkbox' " + checked + "/> <span class='s2-label'></span></div>");
                        $state.find('.s2-label').text(state.text);
                        return $state;
                    },
                    templateSelection: function(state) {
                        // We'll override the rendered area after selection change to show a compact summary
                        return state.text;
                    }
                });
                // After init, ensure the displayed summary is correct
                var updateSummary = function() {
                    var vals = $('#customerFilter').val() || [];
                    var container = $('#customerFilter').siblings('.select2-container').find('.select2-selection__rendered');
                    if (!container || container.length === 0) return;
                    if (vals.length === 0) {
                        // Leave empty so Select2's native placeholder is shown (avoid duplicate text)
                        container.empty();
                    } else if (vals.length === 1) {
                        var txt = $('#customerFilter').find('option[value="' + vals[0] + '"]').text() || vals[0];
                        container.text(txt);
                    } else {
                        container.text(vals.length + ' seleccionados');
                    }
                };

                // Keep Select2 control disabled until populated
                $('#customerFilter').prop('disabled', true);

                // Increase Customer Filter width by 10% to meet UI request
                function increaseCustomerFilterWidth() {
                    try {
                        var sel = document.getElementById('customerFilter');
                        if (!sel) return;
                        // Use the current rendered width
                        var rect = sel.getBoundingClientRect();
                        var currentWidth = rect.width || sel.offsetWidth || 140;
                        var newWidth = Math.round(currentWidth * 1.1);
                        // Apply to the select element
                        sel.style.width = newWidth + 'px';
                        // If Select2 is active, also adjust its container
                        var $cont = $('#customerFilter').siblings('.select2-container');
                        if ($cont && $cont.length) {
                            $cont.css('width', newWidth + 'px');
                            $cont.find('.select2-selection').css('width', newWidth + 'px');
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                // Call once after init to enlarge the control
                increaseCustomerFilterWidth();

                // When dropdown opens we need to update checkboxes states
                $('#customerFilter').on('select2:open', function() {
                    // refresh results so checkboxes reflect actual selection
                    var vals = $('#customerFilter').val() || [];
                    $('.select2-results__option').each(function() {
                        var $opt = $(this);
                        var id = $opt.attr('id');
                        // Select2 internal id format: 'select2-customerFilter-result-xxxxx-<value>' - easier to inspect contained text
                    });
                });

                // Update summary and trigger filters when selection changes
                $('#customerFilter').on('change', function() {
                    updateSummary();
                    // call the native handler directly to avoid recursive dispatch loops
                    try { handleFactoryFilterToggle(); } catch(e) {}
                });

                // Ensure summary is correct on initial render
                updateSummary();
                // Inicializar Select2 para el filtro del modal (chartCustomerFilter)
                try {
                    $('#chartCustomerFilter').attr('multiple', 'multiple');
                    $('#chartCustomerFilter').select2({
                        placeholder: '',
                        allowClear: true,
                        width: 'resolve',
                        closeOnSelect: false,
                        templateResult: function(state) {
                            if (!state.id) return state.text;
                            var checked = state.selected ? 'checked' : '';
                            var $state = $("<div class='s2-result'><input type='checkbox' class='s2-checkbox' " + checked + "/> <span class='s2-label'></span></div>");
                            $state.find('.s2-label').text(state.text);
                            return $state;
                        },
                        templateSelection: function(state) { return state.text; }
                    });
                    // Mantener disabled hasta poblar
                    $('#chartCustomerFilter').prop('disabled', true);
                    // Force a fixed width for the modal select so it does not change when tokens are added
                    try {
                        var $chartSel = $('#chartCustomerFilter');
                        var selEl = document.getElementById('chartCustomerFilter');
                        var rect = selEl.getBoundingClientRect();
                        var fixedWidth = Math.round((rect.width || 220) * 0.8);
                        selEl.style.width = fixedWidth + 'px';
                        $chartSel.siblings('.select2-container').css('width', fixedWidth + 'px');
                        $chartSel.siblings('.select2-container').find('.select2-selection').css('width', fixedWidth + 'px');
                    } catch (e) {}
                    // Actualizar el resumen del control cuando cambie (no reflow de ancho)
                        $('#chartCustomerFilter').on('change', function() {
                        var vals = $('#chartCustomerFilter').val() || [];
                        var container = $('#chartCustomerFilter').siblings('.select2-container').find('.select2-selection__rendered');
                        if (!container || container.length === 0) return;
                        if (vals.length === 0) {
                            container.empty();
                        } else if (vals.length === 1) {
                            var txt = $('#chartCustomerFilter').find('option[value="' + vals[0] + '"]').text() || vals[0];
                            container.text(txt);
                        } else {
                            container.text(vals.length + ' seleccionados');
                        }
                        try { updateChartWithFilter(); } catch(e) {}
                    });
                } catch(e) { /* ignore if chartCustomerFilter not present */ }
                // Mantener disabled hasta que se llamen a populateCustomerFilter
                $('#customerFilter').prop('disabled', true);
            });
        } else {
            // Si no hay jQuery, asegurarse de que el select sea m√∫ltiple nativo
            customerFilter.setAttribute('multiple', 'multiple');
            customerFilter.disabled = true;
        }

        weekSelect.addEventListener('change', handleWeekChange);
        if (yearSelect) yearSelect.addEventListener('change', function() { 
            populateWeekSelect();
            // Si populate estableci√≥ una semana/mes, actualizar tablas autom√°ticamente
            try { if (weekSelect && weekSelect.value) handleWeekChange(); } catch(e) {}
        });
        if (periodSelect) periodSelect.addEventListener('change', function() { 
            populateWeekSelect();
            // Ajustar y actualizar tablas seg√∫n la nueva selecci√≥n de periodo
            try { if (weekSelect && weekSelect.value) handleWeekChange(); } catch(e) {}
        });
        const btnSampleData = document.getElementById('btnSampleData');
        if (btnSampleData) btnSampleData.addEventListener('click', loadSampleData);
        btnDownload.addEventListener('click', downloadExcel);
        btnChart.addEventListener('click', showTrendsChart);
        lastWeekToggle.addEventListener('change', handleLastWeekToggle);
        cititex1Toggle.addEventListener('change', handleFactoryFilterToggle);
        cititex2Toggle.addEventListener('change', handleFactoryFilterToggle);
        cofacoToggle.addEventListener('change', handleFactoryFilterToggle);
        customerFilter.addEventListener('change', handleFactoryFilterToggle);
        closeModal.addEventListener('click', hideModal);
        factoryFilter.addEventListener('change', updateChartWithFilter);
        if (chartCustomerFilter) chartCustomerFilter.addEventListener('change', updateChartWithFilter);
        weekFromFilter.addEventListener('change', updateChartWithFilter);
        weekToFilter.addEventListener('change', updateChartWithFilter);
        
        // Cerrar modal al hacer click fuera de √©l
        window.addEventListener('click', function(event) {
            if (event.target === chartModal) {
                hideModal();
            }
        });

        // Google Sheets helper functions
        function gvizToObjects(resp) {
            if (!resp || !resp.table) return [];
            const cols = (resp.table.cols || []).map(c => String(c.label || c.id || '').trim());
            return (resp.table.rows || []).map(r => {
                const o = {};
                cols.forEach((h, i) => {
                    const cell = r.c && r.c[i] ? r.c[i] : null;
                    o[h] = cell && (cell.v !== null && cell.v !== undefined) ? cell.v : '';
                });
                return o;
            });
        }

        function loadSheetJSONP(sheetId, sheetName) {
            const TIMEOUT_MS = 15000;
            return new Promise((resolve, reject) => {
                const cbName = 'GVIZ_CB_' + Math.random().toString(36).slice(2);
                let script = document.createElement('script');
                let timer = null;

                function cleanup() {
                    if (timer) {
                        clearTimeout(timer);
                        timer = null;
                    }
                    delete window[cbName];
                    if (script && script.parentNode) {
                        script.parentNode.removeChild(script);
                        script = null;
                    }
                }

                timer = setTimeout(() => {
                    cleanup();
                    reject(new Error(`Tiempo de espera agotado al cargar "${sheetName}".`));
                }, TIMEOUT_MS);

                window[cbName] = function (resp) {
                    cleanup();
                    try {
                        resolve(gvizToObjects(resp));
                    } catch (e) {
                        reject(new Error('Error al procesar los datos: ' + e.message));
                    }
                };

                script.onerror = (err) => {
                    cleanup();
                    reject(new Error(`No se pudo cargar la hoja "${sheetName}".`));
                };

                const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq`;
                const url = `${base}?sheet=${encodeURIComponent(sheetName)}&headers=1&tq=${encodeURIComponent('select *')}&tqx=out:json;responseHandler:${cbName}&nocache=${Date.now()}`;

                script.src = url;
                document.head.appendChild(script);
            });
        }

        function showError(msg) {
            errorBanner.textContent = msg;
            errorBanner.style.display = 'block';
            setTimeout(() => {
                errorBanner.style.display = 'none';
            }, 10000);
        }

        function updateLoadingStatus(status, className) {
            // Use innerHTML so callers can pass simple HTML (e.g. a check mark span)
            loadingStatus.innerHTML = status;
            // Preserve the 'badge' base class so the pill-style is kept when changing state
            loadingStatus.className = 'badge ' + className;

            if (className === 'success') {
                btnDownload.disabled = false;
                btnChart.disabled = false;
            }
        }

        function formatNumber(n) {
            if (n === '' || n === null || n === undefined) return '';
            const num = Number(n) || 0;
            return num.toLocaleString('es-PE', { maximumFractionDigits: 0 });
        }

        function processSheetData(jsonData) {
            gridData = jsonData.map(row => {
                    // Funci√≥n helper para obtener valor num√©rico
                    const getNum = (key) => {
                        const val = row[key];
                        if (val === '' || val === null || val === undefined) return 0;
                        const num = parseFloat(val);
                        return isNaN(num) ? 0 : num;
                    };

                    // Funci√≥n helper para obtener valor de texto
                    const getStr = (key) => {
                        const val = row[key];
                        return val ? val.toString().trim() : '';
                    };

                    return {
                        Week: getStr('Week'),
                        'Audit Date': getStr('Audit Date'),
                        Customer: getStr('Customer'),
                        AQL: getStr('AQL'),
                        'N¬∫ Report': getStr('N¬∫ Report'),
                        OP: getStr('OP'),
                        Style: getStr('Style'),
                        Season: getStr('Season'),
                        'Lot # P.O. #': getStr('Lot # P.O. #'),
                        'Color/ID': getStr('Color/ID'),
                        'Lot Size': getNum('Lot Size'),
                        'Sample Size': getNum('Sample Size'),
                        Acceptance: getStr('Acceptance'),
                        Fabric: getNum('Fabric'),
                        'Untrimmed threads End': getNum('Untrimmed threads End'),
                        Embellisment: getNum('Embellisment'),
                        Hole: getNum('Hole'),
                        'Broken/skip stitches': getNum('Broken/skip stitches'),
                        'Color Shading': getNum('Color Shading'),
                        'Puckering/Excessive Fullness': getNum('Puckering/Excessive Fullness'),
                        Cleaness: getNum('Cleaness'),
                        Asymmetrical: getNum('Asymmetrical'),
                        Pin: getNum('Pin'),
                        'Wrong Hangtas': getNum('Wrong Hangtas'),
                        Assorment: getNum('Assorment'),
                        'Shipping Marks': getNum('Shipping Marks'),
                        Others: getNum('Others'),
                        'Meas.': getNum('Meas.'),
                        'Tot. Def.': getNum('Tot.    Def.'),
                        Result: getStr('Result'),
                        '%Defectuoso': getStr('%Defectuoso'),
                        Intento: getNum('Intento'),
                        Validez: getStr('Validez'),
                        'Factory Code': getStr('Factory Code')
                    };
                    });

                    // Normalizar y parsear la columna 'Audit Date' para cada fila y guardar propiedades auxiliares
                    console.log(`[processSheetData] Processing ${gridData.length} rows to parse Audit Date...`);
                    gridData.forEach((row, idx) => {
                        const raw = row['Audit Date'];
                        let parsed = null;
                        try { parsed = parseDateFromString(raw); } catch(e) { parsed = null; }

                        row._parsedAuditDate = parsed;
                        if (parsed && !isNaN(parsed.getTime())) {
                            try {
                                row._auditYear = parsed.getFullYear();
                                row._auditMonth = parsed.getMonth(); // 0..11
                                row._auditISOWeek = getISOWeek(parsed);
                                if (idx < 5) console.log(`  [${idx}] Parsed: ${raw} => Year=${row._auditYear}, Month=${row._auditMonth}, Week=${row._auditISOWeek}`);
                            } catch(e) {
                                console.error(`Error parsing properties for row ${idx} (${raw}):`, e);
                            }
                        } else {
                            if (idx < 5) console.warn(`  [${idx}] Failed to parse: ${raw}`);
                        }
                    });

            // Primero poblar a√±os y periodo por defecto
            console.log('[processSheetData] Populating year and period selects...');
            populateYearSelect();
            // Asegurar periodo por defecto a 'Sem' si no hay valor
            try { 
                if (periodSelect) {
                    periodSelect.value = 'Sem';
                    console.log('[processSheetData] Period set to: Sem');
                }
            } catch(e) { console.error('Error setting period:', e); }
            
            // Intentar seleccionar A√±o 2025 por defecto si existe en las opciones
            try {
                if (yearSelect) {
                    const has2025 = Array.from(yearSelect.options).some(o => o.value === '2025');
                    if (has2025) {
                        yearSelect.value = '2025';
                        console.log('[processSheetData] Year selected: 2025');
                    } else if (yearSelect.options.length > 1) {
                        // seleccionar el √∫ltimo a√±o disponible
                        yearSelect.selectedIndex = yearSelect.options.length - 1;
                        console.log('[processSheetData] Year selected (fallback): ' + yearSelect.value);
                    }
                }
            } catch(e) { console.error('Error setting year:', e); }

            // Poblar el select dependiente (week/month) despu√©s de fijar el a√±o/periodo
            populateWeekSelect();
            console.log('[processSheetData] Week/month select populated');

            // Seleccionar por defecto la semana actual (ISO week) si existe en las opciones
            try {
                const nowWeek = String(getISOWeek(new Date()));
                console.log('[processSheetData] Current ISO week: ' + nowWeek);
                
                if (periodSelect && periodSelect.value === 'Sem') {
                    // buscar opci√≥n con value == nowWeek
                    const opt = Array.from(weekSelect.options).find(o => o.value === nowWeek);
                    if (opt) {
                        weekSelect.value = nowWeek;
                        console.log('[processSheetData] Week selected: ' + nowWeek);
                    } else if (weekSelect.options.length > 1) {
                        // seleccionar la √∫ltima disponible
                        weekSelect.selectedIndex = weekSelect.options.length - 1;
                        console.log('[processSheetData] Week selected (fallback): ' + weekSelect.value);
                    } else {
                        console.warn('[processSheetData] No week options available');
                    }
                }

                // Disparar el filtrado por la selecci√≥n por defecto
                if (weekSelect && weekSelect.value) {
                    console.log('[processSheetData] Triggering handleWeekChange for week: ' + weekSelect.value);
                    try { handleWeekChange(); } catch(e) { console.error('Error in handleWeekChange:', e); }
                } else {
                    console.warn('[processSheetData] No week value to filter');
                }
            } catch(e) { console.error('Error in automatic week selection:', e); }

            updateLoadingStatus('Datos <span class="check">‚úì</span>', 'success');
            // Habilitar controles
            try { if (weekSelect) weekSelect.disabled = false; } catch(e) {}
            try { if (yearSelect) yearSelect.disabled = false; } catch(e) {}
            try { if (btnDownload) btnDownload.disabled = !weekSelect.value; } catch(e) {}
            console.log('[processSheetData] Initialization complete');
        }        function getCurrentWeekNumber() {
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function populateWeekSelect() {
            // Poblar el select dependiente seg√∫n la columna 'Audit Date', el periodo y a√±o seleccionados
            const period = (periodSelect && periodSelect.value) ? periodSelect.value : 'Sem';
            const selectedYear = (yearSelect && yearSelect.value) ? String(yearSelect.value) : '';

            console.log(`[populateWeekSelect] period=${period}, selectedYear=${selectedYear}, gridData.length=${gridData.length}`);

            const values = new Set();
            let processedCount = 0;
            gridData.forEach((row, idx) => {
                const dt = row._parsedAuditDate || parseDateFromString(row['Audit Date']);
                if (!dt || isNaN(dt.getTime())) {
                    if (idx < 3) console.log(`[populateWeekSelect] Row ${idx} has invalid date`);
                    return;
                }
                processedCount++;
                if (selectedYear && String(dt.getFullYear()) !== selectedYear) {
                    if (idx < 3) console.log(`[populateWeekSelect] Row ${idx} year mismatch: ${dt.getFullYear()} != ${selectedYear}`);
                    return;
                }
                if (period === 'Sem') {
                    const wk = String(getISOWeek(dt));
                    values.add(wk);
                } else {
                    const m = dt.getMonth();
                    values.add(String(m));
                }
            });
            
            console.log(`[populateWeekSelect] Processed ${processedCount} valid dates, found ${values.size} unique values`);

            let arr = Array.from(values);
            if (period === 'Sem') {
                arr = arr.map(v => parseInt(v, 10)).filter(n => !isNaN(n)).sort((a,b)=>a-b).map(n=>String(n));
                allWeeks = arr.slice();
                weekSelect.innerHTML = '<option value="">Seleccione Week...</option>';
                arr.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week;
                    option.textContent = 'SEM' + week;
                    weekSelect.appendChild(option);
                });
                console.log(`[populateWeekSelect] Populated ${arr.length} week options: ${arr.join(', ')}`);
                // Seleccionar por defecto la semana actual si existe, o mantener la seleccion previa si la hay
                try {
                    const currentWeek = String(getISOWeek(new Date()));
                    const optNow = Array.from(weekSelect.options).find(o => o.value === currentWeek);
                    if (optNow) {
                        weekSelect.value = currentWeek;
                    } else if (weekSelect.options.length > 1 && !weekSelect.value) {
                        // fallback: seleccionar la ultima disponible
                        weekSelect.selectedIndex = weekSelect.options.length - 1;
                    }
                } catch(e) {}
            } else {
                // Meses: orden por n√∫mero de mes 0..11
                arr = arr.map(v => parseInt(v,10)).filter(n => !isNaN(n)).sort((a,b)=>a-b);
                // Guardar en allWeeks los valores tal y como aparecen en los option (1..12 strings)
                allWeeks = arr.map(m => String(m + 1));
                weekSelect.innerHTML = '<option value="">Seleccione Mes...</option>';
                arr.forEach(m => {
                    const option = document.createElement('option');
                    option.value = String(m+1); // mes 1..12
                    option.textContent = monthNameES(m);
                    weekSelect.appendChild(option);
                });
                console.log(`[populateWeekSelect] Populated ${arr.length} month options`);
            }

            weekSelect.disabled = (arr.length === 0);
            // Ajustar etiqueta del switch dentro del fieldset Week seg√∫n periodo
            try {
                const weekSwitchLabel = document.querySelector('#weekFieldset .switch-label');
                if (weekSwitchLabel) {
                    weekSwitchLabel.textContent = (period === 'Mes') ? 'Last Month' : 'Last Week';
                }
            } catch(e) {}

            // Si el periodo es Mes, intentar seleccionar autom√°ticamente el mes que el usuario est√° viendo ahora.
            if (period === 'Mes') {
                // Si hab√≠a una semana seleccionada previamente, usarla para inferir el mes
                const priorWeekVal = weekSelect.getAttribute('data-previous-week') || '';
                let targetMonth = null;
                // Preferir la semana actualmente seleccionada en el control (si viene de Sem)
                const selectedWeekBefore = (typeof weekSelect !== 'undefined' && weekSelect.value) ? weekSelect.value : null;
                if (selectedWeekBefore) {
                    // Buscar una fila en gridData que coincida con esa semana y determinar su mes
                    for (let i = 0; i < gridData.length; i++) {
                        const r = gridData[i];
                        const dt = r._parsedAuditDate || parseDateFromString(r['Audit Date']);
                        if (!dt) continue;
                        const wk = String(getISOWeek(dt));
                        if (wk === String(selectedWeekBefore)) {
                            targetMonth = String(dt.getMonth() + 1);
                            break;
                        }
                    }
                }
                // Si no encontramos mes basado en la semana seleccionada, usar el mes actual
                if (!targetMonth) {
                    targetMonth = String(new Date().getMonth() + 1);
                }

                // Si la opci√≥n existe en weekSelect, seleccionarla
                if (targetMonth) {
                    const opt = Array.from(weekSelect.options).find(o => o.value === String(targetMonth));
                    if (opt) {
                        weekSelect.value = String(targetMonth);
                    }
                }
            }
            console.log(`[populateWeekSelect] weekSelect.disabled=${weekSelect.disabled}`);
        }

        function handleLastWeekToggle() {
            if (lastWeekToggle.checked) {
                // Guardar la selecci√≥n actual para poder restaurarla al desactivar
                prevWeekSelection = weekSelect && weekSelect.value ? String(weekSelect.value) : null;

                // Determinar la semana base (la que el usuario est√° viendo ahora)
                const baseWeek = weekSelect && weekSelect.value ? String(weekSelect.value) : String(getCurrentWeekNumber());

                // Buscar el √≠ndice de la semana base en allWeeks
                const idx = allWeeks.findIndex(w => String(w) === baseWeek);

                if (idx > 0) {
                    // Seleccionar la semana anterior en la lista de semanas disponibles
                    const prev = allWeeks[idx - 1];
                    weekSelect.value = String(prev);
                    handleWeekChange();
                } else if (idx === 0) {
                    // No hay semana anterior en los datos
                    lastWeekToggle.checked = false;
                    alert('No hay datos disponibles para la semana anterior a la seleccionada');
                } else {
                    // Si baseWeek no est√° en allWeeks, intentar usar baseWeek-1 num√©rico
                    const numericBase = parseInt(baseWeek, 10);
                    if (!isNaN(numericBase)) {
                        const lastWeekNum = numericBase - 1;
                        const lastWeekStr = String(lastWeekNum);
                        const weekExists = allWeeks.find(week => String(week) === lastWeekStr);
                        if (weekExists) {
                            weekSelect.value = lastWeekStr;
                            handleWeekChange();
                        } else {
                            lastWeekToggle.checked = false;
                            alert('No hay datos disponibles para la semana anterior a la seleccionada');
                        }
                    } else {
                        lastWeekToggle.checked = false;
                        alert('No se pudo determinar la semana base para seleccionar la semana anterior');
                    }
                }
            } else {
                // Restaurar la selecci√≥n previa si existe, si no, intentar seleccionar la semana actual
                if (prevWeekSelection) {
                    const weekExists = allWeeks.find(w => String(w) === String(prevWeekSelection));
                    if (weekExists) {
                        weekSelect.value = String(prevWeekSelection);
                        handleWeekChange();
                    }
                    prevWeekSelection = null;
                } else {
                    const currentWeek = getCurrentWeekNumber();
                    const currentWeekStr = String(currentWeek);
                    const weekExists = allWeeks.find(week => week === currentWeekStr);
                    if (weekExists) {
                        weekSelect.value = currentWeekStr;
                        handleWeekChange();
                    }
                }
            }
        }

        function handleWeekChange() {
            const selectedValue = weekSelect.value;
            if (!selectedValue) {
                tablesContainer.classList.add('hidden');
                noDataMessage.classList.add('hidden');
                return;
            }

            const period = (periodSelect && periodSelect.value) ? periodSelect.value : 'Sem';
            const year = (yearSelect && yearSelect.value) ? String(yearSelect.value) : '';

            const weekData = gridData.filter(row => {
                const dt = row._parsedAuditDate || parseDateFromString(row['Audit Date']);
                if (dt) {
                    if (year && String(dt.getFullYear()) !== year) return false;
                    if (period === 'Sem') {
                        return String(getISOWeek(dt)) === String(selectedValue);
                    } else {
                        // month: selectedValue is 1..12
                        return String(dt.getMonth() + 1) === String(selectedValue);
                    }
                }
                // Fallback: if Audit Date no est√° parseable, intentar usar antigua columna Week para periodo Sem
                if (period === 'Sem' && row.Week) {
                    return String(row.Week) === String(selectedValue);
                }
                return false;
            });

            if (weekData.length === 0) {
                tablesContainer.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            noDataMessage.classList.add('hidden');
            tablesContainer.classList.remove('hidden');

            const internaData = weekData.filter(row => 
                row.Validez === 'Interna' || row.Validez === 'Interna , Cliente'
            );

            const clienteData = weekData.filter(row => 
                row.Validez === 'Cliente' || row.Validez === 'Interna , Cliente'
            );

            currentInternaData = internaData;
            currentClienteData = clienteData;

            // Poblar el selector de Customer con valores √∫nicos de ambas tablas
            populateCustomerFilter(internaData, clienteData);

            renderTable(internaBody, internaData, 'INTERNA');
            renderTable(clienteBody, clienteData, 'CLIENTE');
            
            btnDownload.disabled = false;

            // Solo aplicar filtros de Factory Code si hay alg√∫n switch activo o filtro de customer seleccionado
            const anyCustomerSelected = getSelectedCustomers().length > 0;
            if (cofacoToggle.checked || cititex1Toggle.checked || cititex2Toggle.checked || anyCustomerSelected) {
                applyFactoryFilters();
            }
        }

        function populateCustomerFilter(internaData, clienteData) {
            // Obtener todos los customers √∫nicos de ambas tablas
            const allCustomers = new Set();
            
            internaData.forEach(row => {
                if (row['Customer']) {
                    allCustomers.add(row['Customer']);
                }
            });
            
            clienteData.forEach(row => {
                if (row['Customer']) {
                    allCustomers.add(row['Customer']);
                }
            });
            
            // Ordenar alfab√©ticamente
            const sortedCustomers = Array.from(allCustomers).sort();
            
            // Limpiar opciones existentes
            customerFilter.innerHTML = '';
            
            // Agregar opciones
            sortedCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerFilter.appendChild(option);
            });
            
            // Habilitar el selector (y avisar a Select2 si est√° activado)
            try {
                if (window.jQuery && $('#customerFilter').data('select2')) {
                    $('#customerFilter').prop('disabled', false);
                    // Forzar a Select2 a refrescar su lista y a actualizar el resumen mostrado
                    $('#customerFilter').trigger('change');
                } else {
                    customerFilter.disabled = false;
                }
            } catch (e) {
                customerFilter.disabled = false;
            }
        }

        // Poblar el filtro de Customers dentro del modal de gr√°fica
        function populateChartCustomerFilter() {
            const allCustomers = new Set();
            if (gridData && gridData.length > 0) {
                gridData.forEach(row => {
                    // Preferir filas tipo INTERNA (misma l√≥gica que la gr√°fica)
                    const matchesType = (row.Tipo === 'INTERNA' || !row.Tipo);
                    if (matchesType && row['Customer']) {
                        allCustomers.add(row['Customer']);
                    }
                });
            }

            const sorted = Array.from(allCustomers).sort();
            const sel = document.getElementById('chartCustomerFilter');
            if (!sel) return;
            // Limpiar
            sel.innerHTML = '';
            // Agregar opci√≥n vac√≠a (todos)
            const optAll = document.createElement('option');
            optAll.value = '';
            optAll.textContent = 'Todos los Customers';
            sel.appendChild(optAll);

            sorted.forEach(c => {
                const o = document.createElement('option');
                o.value = c;
                o.textContent = c;
                sel.appendChild(o);
            });

            try {
                if (window.jQuery && $('#chartCustomerFilter').data('select2')) {
                    $('#chartCustomerFilter').prop('disabled', false);
                    $('#chartCustomerFilter').trigger('change');
                    // Re-apply fixed width after populating options
                    try {
                        var selEl = document.getElementById('chartCustomerFilter');
                        var rect = selEl.getBoundingClientRect();
                        var fixedW = Math.round((rect.width || 220) * 0.8);
                        selEl.style.width = fixedW + 'px';
                        $('#chartCustomerFilter').siblings('.select2-container').css('width', fixedW + 'px');
                        $('#chartCustomerFilter').siblings('.select2-container').find('.select2-selection').css('width', fixedW + 'px');
                    } catch(e) {}
                } else {
                    sel.disabled = false;
                }
            } catch (e) {
                sel.disabled = false;
            }
        }

        function handleFactoryFilterToggle() {
            // Re-renderizar las tablas con los filtros actualizados
            if (currentInternaData.length > 0 || currentClienteData.length > 0) {
                applyFactoryFilters();
            }
        }

        function applyFactoryFilters() {
            const activeFactories = [];
            if (cofacoToggle.checked) activeFactories.push('Cofaco');
            if (cititex1Toggle.checked) activeFactories.push('Cititex 1');
            if (cititex2Toggle.checked) activeFactories.push('Cititex 2');
            
            const selectedCustomers = getSelectedCustomers();

            // Si no hay ning√∫n filtro activo, mostrar todos los datos originales
            if (activeFactories.length === 0 && selectedCustomers.length === 0) {
                renderTable(internaBody, currentInternaData, 'INTERNA');
                renderTable(clienteBody, currentClienteData, 'CLIENTE');
                return;
            }

            // Filtrar datos INTERNA
            let filteredInternaData = currentInternaData;
            
            // Aplicar filtro de Factory Code si hay factories seleccionadas
            if (activeFactories.length > 0) {
                filteredInternaData = filteredInternaData.filter(row => {
                    const factoryCode = row['Factory Code'];
                    return activeFactories.includes(factoryCode);
                });
            }
            
            // Aplicar filtro de Customer si hay uno o varios seleccionados
            if (selectedCustomers.length > 0) {
                filteredInternaData = filteredInternaData.filter(row => {
                    return selectedCustomers.includes(row['Customer']);
                });
            }

            // Filtrar datos CLIENTE
            let filteredClienteData = currentClienteData;
            
            // Aplicar filtro de Factory Code si hay factories seleccionadas
            if (activeFactories.length > 0) {
                filteredClienteData = filteredClienteData.filter(row => {
                    const factoryCode = row['Factory Code'];
                    return activeFactories.includes(factoryCode);
                });
            }
            
            // Aplicar filtro de Customer si hay uno o varios seleccionados
            if (selectedCustomers.length > 0) {
                filteredClienteData = filteredClienteData.filter(row => {
                    return selectedCustomers.includes(row['Customer']);
                });
            }

            // Re-renderizar las tablas
            renderTable(internaBody, filteredInternaData, 'INTERNA');
            renderTable(clienteBody, filteredClienteData, 'CLIENTE');
        }

        function renderTable(tbody, data, tableType) {
            tbody.innerHTML = '';

            if (data.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 25;
                cell.textContent = 'No hay datos';
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                return;
            }

            // Agrupar primero por Factory Code, luego por Customer
            const groupedByFactory = {};
            data.forEach(row => {
                const factory = row['Factory Code'] || 'Sin c√≥digo';
                const customer = row['Customer'] || 'Sin cliente';
                
                if (!groupedByFactory[factory]) {
                    groupedByFactory[factory] = {};
                }
                
                if (!groupedByFactory[factory][customer]) {
                    groupedByFactory[factory][customer] = [];
                }
                
                groupedByFactory[factory][customer].push(row);
            });

            const totals = {
                'Lot Size': 0,
                'Sample Size': 0,
                'Tot. Def.': 0,
                Fabric: 0,
                'Untrimmed threads End': 0,
                Embellisment: 0,
                Hole: 0,
                'Broken/skip stitches': 0,
                'Color Shading': 0,
                'Puckering/Excessive Fullness': 0,
                Cleaness: 0,
                Asymmetrical: 0,
                Pin: 0,
                'Wrong Hangtas': 0,
                Assorment: 0,
                'Shipping Marks': 0,
                Others: 0,
                'Meas.': 0,
                count: 0,
                A1: 0,
                A2: 0,
                A3: 0,
                A4: 0
            };

            // Procesar cada Factory Code
            Object.keys(groupedByFactory).sort().forEach(factory => {
                const customers = groupedByFactory[factory];
                
                // Subtotal por Factory Code
                const factorySubtotal = {
                    'Lot Size': 0,
                    'Sample Size': 0,
                    'Tot. Def.': 0,
                    Fabric: 0,
                    'Untrimmed threads End': 0,
                    Embellisment: 0,
                    Hole: 0,
                    'Broken/skip stitches': 0,
                    'Color Shading': 0,
                    'Puckering/Excessive Fullness': 0,
                    Cleaness: 0,
                    Asymmetrical: 0,
                    Pin: 0,
                    'Wrong Hangtas': 0,
                    Assorment: 0,
                    'Shipping Marks': 0,
                    Others: 0,
                    'Meas.': 0,
                    count: 0,
                    A1: 0,
                    A2: 0,
                    A3: 0,
                    A4: 0
                };

                // Procesar cada Customer dentro del Factory Code
                Object.keys(customers).sort().forEach(customer => {
                    const rows = customers[customer];
                    const row = tbody.insertRow();

                    const lineSum = {
                        'Lot Size': 0,
                        'Sample Size': 0,
                        'Tot. Def.': 0,
                        Fabric: 0,
                        'Untrimmed threads End': 0,
                        Embellisment: 0,
                        Hole: 0,
                        'Broken/skip stitches': 0,
                        'Color Shading': 0,
                        'Puckering/Excessive Fullness': 0,
                        Cleaness: 0,
                        Asymmetrical: 0,
                        Pin: 0,
                        'Wrong Hangtas': 0,
                        Assorment: 0,
                        'Shipping Marks': 0,
                        Others: 0,
                        'Meas.': 0,
                        count: rows.length,
                        A1: 0,
                        A2: 0,
                        A3: 0,
                        A4: 0
                    };

                    rows.forEach(r => {
                        lineSum['Lot Size'] += r['Lot Size'];
                        lineSum['Sample Size'] += r['Sample Size'];
                        lineSum['Tot. Def.'] += r['Tot. Def.'];
                        lineSum.Fabric += r.Fabric;
                        lineSum['Untrimmed threads End'] += r['Untrimmed threads End'];
                        lineSum.Embellisment += r.Embellisment;
                        lineSum.Hole += r.Hole;
                        lineSum['Broken/skip stitches'] += r['Broken/skip stitches'];
                        lineSum['Color Shading'] += r['Color Shading'];
                        lineSum['Puckering/Excessive Fullness'] += r['Puckering/Excessive Fullness'];
                        lineSum.Cleaness += r.Cleaness;
                        lineSum.Asymmetrical += r.Asymmetrical;
                        lineSum.Pin += r.Pin;
                        lineSum['Wrong Hangtas'] += r['Wrong Hangtas'];
                        lineSum.Assorment += r.Assorment;
                        lineSum['Shipping Marks'] += r['Shipping Marks'];
                        lineSum.Others += r.Others;
                        lineSum['Meas.'] += r['Meas.'];

                        if (r.Intento === 1) lineSum.A1++;
                        if (r.Intento === 2) lineSum.A2++;
                        if (r.Intento === 3) lineSum.A3++;
                        if (r.Intento === 4) lineSum.A4++;
                    });

                    row.insertCell().textContent = factory;
                    row.insertCell().textContent = customer;
                    row.insertCell().textContent = formatNumber(lineSum['Lot Size']);
                    row.insertCell().textContent = formatNumber(lineSum['Sample Size']);
                    
                    // Para las siguientes columnas, si es 0, mostrar pero en color blanco
                    let cell;
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Tot. Def.'];
                    if (lineSum['Tot. Def.'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Fabric;
                    if (lineSum.Fabric === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Untrimmed threads End'];
                    if (lineSum['Untrimmed threads End'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Embellisment;
                    if (lineSum.Embellisment === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Hole;
                    if (lineSum.Hole === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Broken/skip stitches'];
                    if (lineSum['Broken/skip stitches'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Color Shading'];
                    if (lineSum['Color Shading'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Puckering/Excessive Fullness'];
                    if (lineSum['Puckering/Excessive Fullness'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Cleaness;
                    if (lineSum.Cleaness === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Asymmetrical;
                    if (lineSum.Asymmetrical === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Pin;
                    if (lineSum.Pin === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Wrong Hangtas'];
                    if (lineSum['Wrong Hangtas'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Assorment;
                    if (lineSum.Assorment === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Shipping Marks'];
                    if (lineSum['Shipping Marks'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.Others;
                    if (lineSum.Others === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum['Meas.'];
                    if (lineSum['Meas.'] === 0) cell.style.color = 'white';
                    
                    cell = row.insertCell();
                    cell.textContent = lineSum.count;
                    if (lineSum.count === 0) cell.style.color = 'white';
                    
                    // Solo para INTERNA agregar A1-A4
                    if (tableType === 'INTERNA') {
                        cell = row.insertCell();
                        cell.textContent = lineSum.A1;
                        if (lineSum.A1 === 0) cell.style.color = 'white';
                        
                        cell = row.insertCell();
                        cell.textContent = lineSum.A2;
                        if (lineSum.A2 === 0) cell.style.color = 'white';
                        
                        cell = row.insertCell();
                        cell.textContent = lineSum.A3;
                        if (lineSum.A3 === 0) cell.style.color = 'white';
                        
                        cell = row.insertCell();
                        cell.textContent = lineSum.A4;
                        if (lineSum.A4 === 0) cell.style.color = 'white';
                    }

                    // Acumular en el subtotal del Factory Code
                    factorySubtotal['Lot Size'] += lineSum['Lot Size'];
                    factorySubtotal['Sample Size'] += lineSum['Sample Size'];
                    factorySubtotal['Tot. Def.'] += lineSum['Tot. Def.'];
                    factorySubtotal.Fabric += lineSum.Fabric;
                    factorySubtotal['Untrimmed threads End'] += lineSum['Untrimmed threads End'];
                    factorySubtotal.Embellisment += lineSum.Embellisment;
                    factorySubtotal.Hole += lineSum.Hole;
                    factorySubtotal['Broken/skip stitches'] += lineSum['Broken/skip stitches'];
                    factorySubtotal['Color Shading'] += lineSum['Color Shading'];
                    factorySubtotal['Puckering/Excessive Fullness'] += lineSum['Puckering/Excessive Fullness'];
                    factorySubtotal.Cleaness += lineSum.Cleaness;
                    factorySubtotal.Asymmetrical += lineSum.Asymmetrical;
                    factorySubtotal.Pin += lineSum.Pin;
                    factorySubtotal['Wrong Hangtas'] += lineSum['Wrong Hangtas'];
                    factorySubtotal.Assorment += lineSum.Assorment;
                    factorySubtotal['Shipping Marks'] += lineSum['Shipping Marks'];
                    factorySubtotal.Others += lineSum.Others;
                    factorySubtotal['Meas.'] += lineSum['Meas.'];
                    factorySubtotal.count += lineSum.count;
                    factorySubtotal.A1 += lineSum.A1;
                    factorySubtotal.A2 += lineSum.A2;
                    factorySubtotal.A3 += lineSum.A3;
                    factorySubtotal.A4 += lineSum.A4;
                });

                // Agregar fila de subtotal por Factory Code
                const subtotalRow = tbody.insertRow();
                subtotalRow.style.fontWeight = '600';
                subtotalRow.setAttribute('style', 'background-color: #90ee90 !important; font-weight: 600;');

                subtotalRow.insertCell().textContent = 'Total ' + factory;
                subtotalRow.insertCell().textContent = '';
                subtotalRow.insertCell().textContent = formatNumber(factorySubtotal['Lot Size']);
                subtotalRow.insertCell().textContent = formatNumber(factorySubtotal['Sample Size']);
                subtotalRow.insertCell().textContent = factorySubtotal['Tot. Def.'];
                subtotalRow.insertCell().textContent = factorySubtotal.Fabric;
                subtotalRow.insertCell().textContent = factorySubtotal['Untrimmed threads End'];
                subtotalRow.insertCell().textContent = factorySubtotal.Embellisment;
                subtotalRow.insertCell().textContent = factorySubtotal.Hole;
                subtotalRow.insertCell().textContent = factorySubtotal['Broken/skip stitches'];
                subtotalRow.insertCell().textContent = factorySubtotal['Color Shading'];
                subtotalRow.insertCell().textContent = factorySubtotal['Puckering/Excessive Fullness'];
                subtotalRow.insertCell().textContent = factorySubtotal.Cleaness;
                subtotalRow.insertCell().textContent = factorySubtotal.Asymmetrical;
                subtotalRow.insertCell().textContent = factorySubtotal.Pin;
                subtotalRow.insertCell().textContent = factorySubtotal['Wrong Hangtas'];
                subtotalRow.insertCell().textContent = factorySubtotal.Assorment;
                subtotalRow.insertCell().textContent = factorySubtotal['Shipping Marks'];
                subtotalRow.insertCell().textContent = factorySubtotal.Others;
                subtotalRow.insertCell().textContent = factorySubtotal['Meas.'];
                subtotalRow.insertCell().textContent = factorySubtotal.count;
                
                // Solo para INTERNA agregar A1-A4
                if (tableType === 'INTERNA') {
                    subtotalRow.insertCell().textContent = factorySubtotal.A1;
                    subtotalRow.insertCell().textContent = factorySubtotal.A2;
                    subtotalRow.insertCell().textContent = factorySubtotal.A3;
                    subtotalRow.insertCell().textContent = factorySubtotal.A4;
                }

                // Acumular en el total general
                totals['Lot Size'] += factorySubtotal['Lot Size'];
                totals['Sample Size'] += factorySubtotal['Sample Size'];
                totals['Tot. Def.'] += factorySubtotal['Tot. Def.'];
                totals.Fabric += factorySubtotal.Fabric;
                totals['Untrimmed threads End'] += factorySubtotal['Untrimmed threads End'];
                totals.Embellisment += factorySubtotal.Embellisment;
                totals.Hole += factorySubtotal.Hole;
                totals['Broken/skip stitches'] += factorySubtotal['Broken/skip stitches'];
                totals['Color Shading'] += factorySubtotal['Color Shading'];
                totals['Puckering/Excessive Fullness'] += factorySubtotal['Puckering/Excessive Fullness'];
                totals.Cleaness += factorySubtotal.Cleaness;
                totals.Asymmetrical += factorySubtotal.Asymmetrical;
                totals.Pin += factorySubtotal.Pin;
                totals['Wrong Hangtas'] += factorySubtotal['Wrong Hangtas'];
                totals.Assorment += factorySubtotal.Assorment;
                totals['Shipping Marks'] += factorySubtotal['Shipping Marks'];
                totals.Others += factorySubtotal.Others;
                totals['Meas.'] += factorySubtotal['Meas.'];
                totals.count += factorySubtotal.count;
                totals.A1 += factorySubtotal.A1;
                totals.A2 += factorySubtotal.A2;
                totals.A3 += factorySubtotal.A3;
                totals.A4 += factorySubtotal.A4;
            });

            const totalRow = tbody.insertRow();
            totalRow.className = 'total-row';

            const totalDefectRate = totals['Sample Size'] > 0 
                ? (totals['Tot. Def.'] / totals['Sample Size'] * 100).toFixed(2) + '%'
                : '0.00%';

            totalRow.insertCell().textContent = 'Total general';
            totalRow.insertCell().textContent = '';
            totalRow.insertCell().textContent = formatNumber(totals['Lot Size']);
            totalRow.insertCell().textContent = formatNumber(totals['Sample Size']);
            totalRow.insertCell().textContent = totals['Tot. Def.'];
            totalRow.insertCell().textContent = totals.Fabric;
            totalRow.insertCell().textContent = totals['Untrimmed threads End'];
            totalRow.insertCell().textContent = totals.Embellisment;
            totalRow.insertCell().textContent = totals.Hole;
            totalRow.insertCell().textContent = totals['Broken/skip stitches'];
            totalRow.insertCell().textContent = totals['Color Shading'];
            totalRow.insertCell().textContent = totals['Puckering/Excessive Fullness'];
            totalRow.insertCell().textContent = totals.Cleaness;
            totalRow.insertCell().textContent = totals.Asymmetrical;
            totalRow.insertCell().textContent = totals.Pin;
            totalRow.insertCell().textContent = totals['Wrong Hangtas'];
            totalRow.insertCell().textContent = totals.Assorment;
            totalRow.insertCell().textContent = totals['Shipping Marks'];
            totalRow.insertCell().textContent = totals.Others;
            totalRow.insertCell().textContent = totals['Meas.'];
            totalRow.insertCell().textContent = totals.count;
            
            // Solo para INTERNA agregar A1-A4
            if (tableType === 'INTERNA') {
                totalRow.insertCell().textContent = totals.A1;
                
                const cellA2 = totalRow.insertCell();
                cellA2.textContent = totals.A2;
                cellA2.style.backgroundColor = 'white';
                
                const cellA3 = totalRow.insertCell();
                cellA3.textContent = totals.A3;
                cellA3.style.backgroundColor = 'white';
                
                const cellA4 = totalRow.insertCell();
                cellA4.textContent = totals.A4;
                cellA4.style.backgroundColor = 'white';
            }

            // Fila DEFECTUOSO
            const defectuosoRow = tbody.insertRow();
            defectuosoRow.className = 'total-row';
            defectuosoRow.setAttribute('style', 'background-color: #1a4d1a !important; color: white !important;');
            
            const defectuosoLabelCell = defectuosoRow.insertCell();
            defectuosoLabelCell.textContent = 'DEFECTUOSO';
            defectuosoLabelCell.style.fontWeight = '700';
            defectuosoLabelCell.colSpan = 4;
            
            // Columna 5 (Tot. Def.) - Base para divisiones
            const sampleSizeTotal = totals['Sample Size']; // Columna 4
            
            // Columnas 5-20: Porcentajes (cada columna / Sample Size)
            const defectuosoTotDef = sampleSizeTotal > 0 ? (totals['Tot. Def.'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = defectuosoTotDef;
            
            const fabricPercent = sampleSizeTotal > 0 ? (totals.Fabric / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = fabricPercent;
            
            const untrimmedPercent = sampleSizeTotal > 0 ? (totals['Untrimmed threads End'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = untrimmedPercent;
            
            const embellismentPercent = sampleSizeTotal > 0 ? (totals.Embellisment / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = embellismentPercent;
            
            const holePercent = sampleSizeTotal > 0 ? (totals.Hole / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = holePercent;
            
            const brokenPercent = sampleSizeTotal > 0 ? (totals['Broken/skip stitches'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = brokenPercent;
            
            const colorPercent = sampleSizeTotal > 0 ? (totals['Color Shading'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = colorPercent;
            
            const puckeringPercent = sampleSizeTotal > 0 ? (totals['Puckering/Excessive Fullness'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = puckeringPercent;
            
            const cleanessPercent = sampleSizeTotal > 0 ? (totals.Cleaness / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = cleanessPercent;
            
            const asymmetricalPercent = sampleSizeTotal > 0 ? (totals.Asymmetrical / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = asymmetricalPercent;
            
            const pinPercent = sampleSizeTotal > 0 ? (totals.Pin / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = pinPercent;
            
            const wrongPercent = sampleSizeTotal > 0 ? (totals['Wrong Hangtas'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = wrongPercent;
            
            const assormentPercent = sampleSizeTotal > 0 ? (totals.Assorment / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = assormentPercent;
            
            const shippingPercent = sampleSizeTotal > 0 ? (totals['Shipping Marks'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = shippingPercent;
            
            const othersPercent = sampleSizeTotal > 0 ? (totals.Others / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = othersPercent;
            
            const measPercent = sampleSizeTotal > 0 ? (totals['Meas.'] / sampleSizeTotal * 100).toFixed(2) + '%' : '0.00%';
            defectuosoRow.insertCell().textContent = measPercent;
            
            // Columnas 21-24: vac√≠as o con valores especiales para INTERNA
            if (tableType === 'INTERNA') {
                // Columna "Cuenta de N¬∫ Report" - PASS
                defectuosoRow.insertCell().textContent = 'PASS';
                
                // Columna A1 - Porcentaje A1 / (A1+A2+A3+A4)
                const totalIntentos = totals.A1 + totals.A2 + totals.A3 + totals.A4;
                const a1Percent = totalIntentos > 0 ? Math.round(totals.A1 / totalIntentos * 100) + '%' : '0%';
                defectuosoRow.insertCell().textContent = a1Percent;
                
                // Columnas A2, A3, A4 vac√≠as con fondo blanco
                for (let i = 0; i < 3; i++) {
                    const cell = defectuosoRow.insertCell();
                    cell.textContent = '';
                    cell.style.backgroundColor = 'white';
                }
            } else {
                // Para CLIENTE, todas vac√≠as con fondo blanco
                for (let i = 0; i < 4; i++) {
                    const cell = defectuosoRow.insertCell();
                    cell.textContent = '';
                    cell.style.backgroundColor = 'white';
                }
            }

            // Fila de porcentajes individuales
            const percentRow = tbody.insertRow();
            percentRow.setAttribute('style', 'background-color: #4a4a4a !important; color: white !important;');
            const percentEmptyCell = percentRow.insertCell();
            percentEmptyCell.colSpan = 5;
            percentEmptyCell.textContent = '';

            // Calcular porcentajes individuales (cada columna / Tot. Def.)
            const totDefTotal = totals['Tot. Def.'];
            
            const fabricPercent2 = totDefTotal > 0 ? Math.round(totals.Fabric / totDefTotal * 100) + '%' : '0%';
            const untrimmedPercent2 = totDefTotal > 0 ? Math.round(totals['Untrimmed threads End'] / totDefTotal * 100) + '%' : '0%';
            const embellismentPercent2 = totDefTotal > 0 ? Math.round(totals.Embellisment / totDefTotal * 100) + '%' : '0%';
            const holePercent2 = totDefTotal > 0 ? Math.round(totals.Hole / totDefTotal * 100) + '%' : '0%';
            const brokenPercent2 = totDefTotal > 0 ? Math.round(totals['Broken/skip stitches'] / totDefTotal * 100) + '%' : '0%';
            const colorPercent2 = totDefTotal > 0 ? Math.round(totals['Color Shading'] / totDefTotal * 100) + '%' : '0%';
            const puckeringPercent2 = totDefTotal > 0 ? Math.round(totals['Puckering/Excessive Fullness'] / totDefTotal * 100) + '%' : '0%';
            const cleanessPercent2 = totDefTotal > 0 ? Math.round(totals.Cleaness / totDefTotal * 100) + '%' : '0%';
            const asymmetricalPercent2 = totDefTotal > 0 ? Math.round(totals.Asymmetrical / totDefTotal * 100) + '%' : '0%';
            const pinPercent2 = totDefTotal > 0 ? Math.round(totals.Pin / totDefTotal * 100) + '%' : '0%';
            const wrongPercent2 = totDefTotal > 0 ? Math.round(totals['Wrong Hangtas'] / totDefTotal * 100) + '%' : '0%';
            const assormentPercent2 = totDefTotal > 0 ? Math.round(totals.Assorment / totDefTotal * 100) + '%' : '0%';
            const shippingPercent2 = totDefTotal > 0 ? Math.round(totals['Shipping Marks'] / totDefTotal * 100) + '%' : '0%';
            const othersPercent2 = totDefTotal > 0 ? Math.round(totals.Others / totDefTotal * 100) + '%' : '0%';
            const measPercent2 = totDefTotal > 0 ? Math.round(totals['Meas.'] / totDefTotal * 100) + '%' : '0%';

            percentRow.insertCell().textContent = fabricPercent2;
            percentRow.insertCell().textContent = untrimmedPercent2;
            percentRow.insertCell().textContent = embellismentPercent2;
            percentRow.insertCell().textContent = holePercent2;
            percentRow.insertCell().textContent = brokenPercent2;
            percentRow.insertCell().textContent = colorPercent2;
            percentRow.insertCell().textContent = puckeringPercent2;
            percentRow.insertCell().textContent = cleanessPercent2;
            percentRow.insertCell().textContent = asymmetricalPercent2;
            percentRow.insertCell().textContent = pinPercent2;
            percentRow.insertCell().textContent = wrongPercent2;
            percentRow.insertCell().textContent = assormentPercent2;
            percentRow.insertCell().textContent = shippingPercent2;
            percentRow.insertCell().textContent = othersPercent2;
            percentRow.insertCell().textContent = measPercent2;
            
            // √öltimas columnas: vac√≠as o con valores especiales para INTERNA
            if (tableType === 'INTERNA') {
                // Columna "Cuenta de N¬∫ Report" - FAIL
                percentRow.insertCell().textContent = 'FAIL';
                
                // Columna A1 - 100% - valor de la fila DEFECTUOSO
                const totalIntentos = totals.A1 + totals.A2 + totals.A3 + totals.A4;
                const a1PercentDefectuoso = totalIntentos > 0 ? (totals.A1 / totalIntentos * 100) : 0;
                const a1PercentFinal = Math.round(100 - a1PercentDefectuoso) + '%';
                percentRow.insertCell().textContent = a1PercentFinal;
                
                // Columnas A2, A3, A4 vac√≠as con fondo blanco
                for (let i = 0; i < 3; i++) {
                    const cell = percentRow.insertCell();
                    cell.textContent = '';
                    cell.style.backgroundColor = 'white';
                }
            } else {
                // Para CLIENTE, todas vac√≠as con fondo blanco
                for (let i = 0; i < 4; i++) {
                    const cell = percentRow.insertCell();
                    cell.textContent = '';
                    cell.style.backgroundColor = 'white';
                }
            }
        }

        // Funci√≥n para poblar los dropdowns de semanas
        function populateWeekFilters() {
            // Obtener todas las semanas disponibles
            let availableWeeks = [];
            const period = (periodSelect && periodSelect.value) ? periodSelect.value : 'Sem';
            
            if (allWeeks && allWeeks.length > 0) {
                availableWeeks = [...allWeeks].sort((a, b) => parseInt(a) - parseInt(b));
            } else {
                // Usar semanas de ejemplo si no hay datos reales
                availableWeeks = ['41', '43', '44', '45', '46', '47'];
            }
            
            console.log('Available weeks for filters:', availableWeeks);
            
            // Limpiar los dropdowns
            weekFromFilter.innerHTML = '';
            weekToFilter.innerHTML = '';
            
            // Para periodo 'Mes' queremos mostrar los √∫ltimos 6 meses (mes actual y 5 anteriores).
            if (period === 'Mes') {
                // availableWeeks contiene meses como strings '1'..'12' si existen en datos
                const availableMonths = availableWeeks.map(w => parseInt(w,10)).filter(n => !isNaN(n));

                // Calcular √∫ltimos 6 meses (1..12)
                const now = new Date();
                const currentMonth = now.getMonth() + 1; // 1..12
                const monthsNeeded = [];
                for (let i = 5; i >= 0; i--) {
                    let m = currentMonth - i;
                    while (m <= 0) m += 12;
                    monthsNeeded.push(m);
                }

                // Unir y ordenar opciones para mostrar (asegurar que monthsNeeded est√©n presentes)
                const unionSet = new Set([...availableMonths, ...monthsNeeded]);
                const unionArr = Array.from(unionSet).map(n => parseInt(n,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);

                unionArr.forEach(m => {
                    const optionFrom = document.createElement('option');
                    const optionTo = document.createElement('option');
                    optionFrom.value = String(m);
                    optionFrom.textContent = monthNameES(m - 1);
                    optionTo.value = String(m);
                    optionTo.textContent = monthNameES(m - 1);
                    weekFromFilter.appendChild(optionFrom);
                    weekToFilter.appendChild(optionTo);
                });

                // Seleccionar el rango monthsNeeded (primer y √∫ltimo)
                weekFromFilter.value = String(monthsNeeded[0]);
                weekToFilter.value = String(monthsNeeded[monthsNeeded.length - 1]);
            } else {
                // Poblar ambos dropdowns con las semanas disponibles
                availableWeeks.forEach(w => {
                    const optionFrom = document.createElement('option');
                    const optionTo = document.createElement('option');
                    optionFrom.value = String(w);
                    optionFrom.textContent = `SEM${w}`;
                    optionTo.value = String(w);
                    optionTo.textContent = `SEM${w}`;
                    weekFromFilter.appendChild(optionFrom);
                    weekToFilter.appendChild(optionTo);
                });

                // Establecer valores por defecto (√∫ltimas 6 semanas si hay suficientes)
                if (availableWeeks.length >= 6) {
                    weekFromFilter.value = availableWeeks[availableWeeks.length - 6];
                    weekToFilter.value = availableWeeks[availableWeeks.length - 1];
                } else if (availableWeeks.length > 0) {
                    weekFromFilter.value = availableWeeks[0];
                    weekToFilter.value = availableWeeks[availableWeeks.length - 1];
                }
            }
            
            console.log('Week filters set: from', weekFromFilter.value, 'to', weekToFilter.value);
        }

        // Funci√≥n para poblar el dropdown de Factory Codes
        function populateFactoryFilter() {
            // Obtener Factory Codes √∫nicos de los datos
            let factoryCodes = [];
            
            if (gridData && gridData.length > 0) {
                factoryCodes = [...new Set(gridData
                    .filter(row => row.Tipo === 'INTERNA' && row['Factory Code'])
                    .map(row => row['Factory Code']))].sort();
            }
            
            // Si no hay datos reales, usar Factory Codes de ejemplo
            if (factoryCodes.length === 0) {
                factoryCodes = ['Cititex 1', 'Cititex 2', 'Cofaco'];
            }
            
            console.log('Available Factory Codes:', factoryCodes);
            
            // Limpiar el dropdown y agregar "Todos"
            factoryFilter.innerHTML = '<option value="all">Todos los Factory Codes</option>';
            
            // Agregar cada Factory Code como opci√≥n
            factoryCodes.forEach(factory => {
                const option = document.createElement('option');
                option.value = factory;
                option.textContent = factory;
                factoryFilter.appendChild(option);
            });
        }

        // Funci√≥n para actualizar la gr√°fica cuando cambia cualquier filtro
        function updateChartWithFilter() {
            const selectedFactory = factoryFilter.value;
            const weekFrom = weekFromFilter.value;
            const weekTo = weekToFilter.value;
            const selectedChartCustomers = getSelectedChartCustomers();
            
            console.log('Filters changed - Factory:', selectedFactory, 'From:', weekFrom, 'To:', weekTo);
            
            // Validar que ambas semanas est√©n seleccionadas
            if (!weekFrom || !weekTo) {
                console.log('Week range not fully selected');
                return;
            }
            
            // Validar que el rango sea v√°lido
            if (parseInt(weekFrom) > parseInt(weekTo)) {
                alert('La semana "desde" debe ser menor o igual a la semana "hasta"');
                return;
            }
            
            const weekData = getWeeklyTrendsDataByRange(selectedFactory, selectedChartCustomers);
            if (weekData.length === 0) {
                alert('No hay datos para los filtros seleccionados');
                return;
            }
            
            createTrendsChart(weekData);
        }

        // Funci√≥n para mostrar el modal con la gr√°fica
        function showTrendsChart() {
            console.log('Datos disponibles:', allWeeks);
            console.log('GridData sample:', gridData ? gridData.slice(0, 3) : 'No data');
            
            // Poblar los dropdowns
            populateFactoryFilter();
            populateWeekFilters();
            
            const selectedFactory = factoryFilter.value;
            // Poblar el filtro de customers del modal
            populateChartCustomerFilter();
            const selectedChartCustomers = getSelectedChartCustomers();
            const weekData = getWeeklyTrendsDataByRange(selectedFactory, selectedChartCustomers);
            console.log('Week data for chart:', weekData);
            console.log('BAP values:', weekData.map(w => ({ week: w.week, bap: w.bap })));
            
            if (weekData.length === 0) {
                alert('No hay datos suficientes para mostrar la tendencia');
                return;
            }
            
            chartModal.classList.add('open');
            createTrendsChart(weekData);
        }

        // Funci√≥n para ocultar el modal
        function hideModal() {
            chartModal.classList.remove('open');
            // Destruir la gr√°fica existente si existe
            const existingChart = Chart.getChart('trendsChart');
            if (existingChart) {
                existingChart.destroy();
            }
        }

        // Funci√≥n para obtener datos de tendencias por rango de semanas
        function getWeeklyTrendsDataByRange(selectedFactory = 'all', selectedChartCustomers = []) {
            const weekFrom = parseInt(weekFromFilter.value);
            const weekTo = parseInt(weekToFilter.value);
            const period = (periodSelect && periodSelect.value) ? periodSelect.value : 'Sem';
            
            console.log(`Getting trends data from week ${weekFrom} to ${weekTo} for factory:`, selectedFactory);
            
            // Validar que el rango sea v√°lido
            if (!weekFrom || !weekTo || weekFrom > weekTo) {
                console.error('Invalid week range');
                return [];
            }
            
            // Obtener todas las semanas/meses disponibles en el rango
            let available = [];
            if (allWeeks && allWeeks.length > 0) {
                available = allWeeks.filter(v => {
                    const n = parseInt(v,10);
                    return n >= weekFrom && n <= weekTo;
                }).sort((a,b)=>parseInt(a)-parseInt(b));
            } else {
                // Fallback sample
                if (period === 'Mes') {
                    available = ['7','8','9','10','11','12'].filter(v => parseInt(v) >= weekFrom && parseInt(v) <= weekTo);
                } else {
                    const sampleWeeks = ['41','43','44','45','46','47'];
                    available = sampleWeeks.filter(v => parseInt(v) >= weekFrom && parseInt(v) <= weekTo);
                }
            }

            console.log('Range available values:', available);

            const weeksData = [];

            if (period === 'Mes') {
                // available contains month numbers as strings (1..12)
                available.forEach(m => {
                    const monthNum = parseInt(m,10);
                    const label = monthNameES(monthNum - 1);
                    const defects = getTotalDefectsForMonth(monthNum, selectedFactory, selectedChartCustomers);
                    const bap = getBAPForMonth(monthNum, selectedFactory, selectedChartCustomers);
                    weeksData.push({ week: label, defects: defects, bap: bap });
                });
            } else {
                available.forEach(week => {
                    const weekNumber = parseInt(week,10);
                    const weekName = `SEM${week}`;
                    const weekDefects = getTotalDefectsForWeek(weekNumber, selectedFactory, selectedChartCustomers);
                    const weekBAP = getBAPForWeek(weekNumber, selectedFactory, selectedChartCustomers);
                    weeksData.push({ week: weekName, defects: weekDefects, bap: weekBAP });
                });
            }
            
            console.log('Range data for', selectedFactory, ':', weeksData);
            return weeksData;
        }

        // Funci√≥n para obtener los datos de tendencias de las √∫ltimas 6 semanas
        function getWeeklyTrendsData(selectedFactory = 'all') {
            console.log('Getting weekly trends data for factory:', selectedFactory);
            console.log('Available weeks:', allWeeks);
            
            // Si no hay semanas disponibles, usar semanas de ejemplo
            if (!allWeeks || allWeeks.length === 0) {
                console.log('No weeks available, using sample weeks');
                const sampleWeeks = ['41', '43', '44', '45', '46', '47'];
                const weeksData = [];
                
                sampleWeeks.forEach(week => {
                    const weekNumber = parseInt(week);
                    const weekName = `SEM${week}`;
                    const weekDefects = getTotalDefectsForWeek(weekNumber, selectedFactory, getSelectedChartCustomers());
                    const weekBAP = getBAPForWeek(weekNumber, selectedFactory, getSelectedChartCustomers());
                    
                    console.log(`Week ${week}: defects=${weekDefects}, BAP=${weekBAP}`);
                    
                    weeksData.push({
                        week: weekName,
                        defects: weekDefects,
                        bap: weekBAP
                    });
                });
                
                console.log('Sample weeks data:', weeksData);
                return weeksData;
            }
            
            // Obtener las √∫ltimas 6 semanas disponibles en los datos
            const lastSixWeeks = allWeeks.slice(-6);
            const weeksData = [];
            
            lastSixWeeks.forEach(week => {
                const weekNumber = parseInt(week);
                const weekName = `SEM${week}`;
                
                // Buscar datos para esta semana y factory
                const weekDefects = getTotalDefectsForWeek(weekNumber, selectedFactory, getSelectedChartCustomers());
                const weekBAP = getBAPForWeek(weekNumber, selectedFactory, getSelectedChartCustomers());
                
                weeksData.push({
                    week: weekName,
                    defects: weekDefects,
                    bap: weekBAP
                });
            });
            
            console.log('Real weeks data for', selectedFactory, ':', weeksData);
            return weeksData;
        }

        // Funci√≥n para obtener el n√∫mero de semana actual
        function getCurrentWeek() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const diff = now - start;
            const oneWeek = 1000 * 60 * 60 * 24 * 7;
            return Math.ceil(diff / oneWeek);
        }

        // Funci√≥n para obtener el porcentaje BAP (A1) de una semana espec√≠fica
        function getBAPForWeek(weekNumber, selectedFactory = 'all') {
            console.log('=== Getting BAP data for week:', weekNumber, 'factory:', selectedFactory, '===');
            
            // Calcular BAP a partir de la columna 'Intento'
            // Numerador: conteo de filas donde Intento == 1
            // Denominador: conteo de filas donde Intento tiene dato (no vac√≠o)
            const weekStr = weekNumber.toString();

            // Si no hay datos cargados, usar datos de ejemplo como fallback
            if (!gridData || gridData.length === 0) {
                console.log('No gridData available, using sample BAP data');
                const sampleBAPData = {
                    '41': 0,
                    '43': 77,
                    '44': 78,
                    '45': 85,
                    '46': 84,
                    '47': 89
                };
                const sampleResult = sampleBAPData[weekStr] || 0;
                console.log(`Sample BAP for week ${weekNumber}:`, sampleResult);
                return sampleResult;
            }

            // Filtrar filas por semana, tipo y factory (misma l√≥gica que getTotalDefectsForWeek)
            const selectedChartCustomers = arguments.length > 2 && Array.isArray(arguments[2]) ? arguments[2] : [];
            const rows = gridData.filter(row => {
                let matchesWeek = false;
                if (row._auditISOWeek !== undefined && row._auditISOWeek !== null) {
                    matchesWeek = String(row._auditISOWeek) === weekStr;
                } else if (row.Week) {
                    matchesWeek = String(row.Week) === weekStr;
                }
                const matchesType = (row.Tipo === 'INTERNA' || !row.Tipo);
                const matchesFactory = selectedFactory === 'all' || row['Factory Code'] === selectedFactory;
                const matchesCustomer = (!selectedChartCustomers || selectedChartCustomers.length === 0) || selectedChartCustomers.includes(row['Customer']);
                return matchesWeek && matchesType && matchesFactory && matchesCustomer;
            });

            console.log(`Week ${weekStr}, Factory ${selectedFactory} filtered rows for BAP:`, rows.length);

            if (rows.length === 0) {
                console.log('No rows for week', weekStr, 'using sample BAP fallback');
                const sampleBAPData = {
                    '41': 0,
                    '43': 77,
                    '44': 78,
                    '45': 85,
                    '46': 84,
                    '47': 89
                };
                return sampleBAPData[weekStr] || 0;
            }

            let intentoOnes = 0;
            let intentoAny = 0;

            rows.forEach(r => {
                const intentoRaw = r['Intento'];
                // Considerar que 'tener dato' significa distinto de '', null o undefined
                if (intentoRaw !== '' && intentoRaw !== null && intentoRaw !== undefined) {
                    intentoAny++;
                    const intentoNum = parseInt(String(intentoRaw).trim());
                    if (!isNaN(intentoNum) && intentoNum === 1) {
                        intentoOnes++;
                    }
                }
            });

            console.log(`Intento counts for week ${weekStr}: ones=${intentoOnes}, any=${intentoAny}`);

            if (intentoAny === 0) return 0;

            const bap = (intentoOnes / intentoAny) * 100;
            // Devolver sin decimales (entero)
            const rounded = Math.round(bap);
            console.log(`Calculated BAP for week ${weekStr}:`, rounded);
            return rounded;
        }

        // Funci√≥n para obtener el porcentaje de defectuosos de la fila DEFECTUOSO para una semana espec√≠fica
        function getTotalDefectsForWeek(weekNumber, selectedFactory = 'all') {
            console.log('Getting defects data for week:', weekNumber, 'factory:', selectedFactory);
            
            // Si no hay datos cargados, usar los datos de ejemplo
            if (!gridData || gridData.length === 0) {
                console.log('No gridData available, using sample data');
                // Datos de ejemplo basados en los valores reales que proporcionaste
                const sampleData = {
                    '41': 8.00,
                    '43': 5.28,
                    '44': 3.87,
                    '45': 3.77,
                    '46': 3.00,
                    '47': 3.74
                };
                return sampleData[weekNumber.toString()] || 0;
            }
            
            // Filtrar datos por semana y factory
            const weekStr = weekNumber.toString();
            const selectedChartCustomers = arguments.length > 2 && Array.isArray(arguments[2]) ? arguments[2] : [];
            const weekData = gridData.filter(row => {
                // Asegurarse de que la semana coincida, que sea de tipo INTERNA y del factory seleccionado
                let matchesWeek = false;
                if (row._auditISOWeek !== undefined && row._auditISOWeek !== null) {
                    matchesWeek = String(row._auditISOWeek) === weekStr;
                } else if (row.Week) {
                    matchesWeek = String(row.Week) === weekStr;
                }
                const matchesType = (row.Tipo === 'INTERNA' || !row.Tipo);
                const matchesFactory = selectedFactory === 'all' || row['Factory Code'] === selectedFactory;
                const matchesCustomer = (!selectedChartCustomers || selectedChartCustomers.length === 0) || selectedChartCustomers.includes(row['Customer']);
                return matchesWeek && matchesType && matchesFactory && matchesCustomer;
            });
            
            console.log(`Week ${weekStr}, Factory ${selectedFactory} filtered data:`, weekData.length, 'rows');
            
            if (weekData.length === 0) {
                console.log('No data for week', weekStr, 'using sample data');
                // Fallback a datos de ejemplo si no hay datos reales
                const sampleData = {
                    '41': 8.00,
                    '43': 5.28,
                    '44': 3.87,
                    '45': 3.77,
                    '46': 3.00,
                    '47': 3.74
                };
                return sampleData[weekStr] || 0;
            }
            
            // Calcular el porcentaje DEFECTUOSO para esta semana
            let totalDefects = 0;
            let totalSampleSize = 0;
            
            weekData.forEach(row => {
                // Intentar diferentes nombres de columnas que podr√≠an existir
                const defects = parseFloat(row['Tot. Def.']) || 
                               parseFloat(row['Tot.    Def.']) || 
                               parseFloat(row['Tot Def']) || 0;
                
                const sampleSize = parseFloat(row['Sample Size']) || 
                                  parseFloat(row['Sample    Size']) || 
                                  parseFloat(row['SampleSize']) || 0;
                
                totalDefects += defects;
                totalSampleSize += sampleSize;
                
                console.log(`Row data: defects=${defects}, sampleSize=${sampleSize}`);
            });
            
            console.log(`Week ${weekStr} totals: defects=${totalDefects}, sampleSize=${totalSampleSize}`);
            
            // Calcular el porcentaje
            const defectivePercentage = totalSampleSize > 0 ? 
                (totalDefects / totalSampleSize * 100) : 0;
            
            console.log(`Week ${weekStr} calculated percentage: ${defectivePercentage.toFixed(2)}%`);
            
            // Retornar el porcentaje con 2 decimales
            return Math.round(defectivePercentage * 100) / 100;
        }

        // Funci√≥n para obtener datos por mes (mesNumber 1..12)
        function getTotalDefectsForMonth(monthNumber, selectedFactory = 'all') {
            console.log('Getting defects data for month:', monthNumber, 'factory:', selectedFactory);
            const monthIndex = parseInt(monthNumber,10) - 1; // 0..11

            if (!gridData || gridData.length === 0) {
                console.log('No gridData available, using sample month data');
                // Fallback simple sample percentages (placeholder)
                const sample = {7:3.71,8:2.91,9:3.16,10:4.22,11:4.22,12:3.01};
                return sample[monthNumber] || 0;
            }

            const selectedChartCustomers = arguments.length > 2 && Array.isArray(arguments[2]) ? arguments[2] : [];
            const rows = gridData.filter(row => {
                let matchesMonth = false;
                if (row._auditMonth !== undefined && row._auditMonth !== null) {
                    matchesMonth = Number(row._auditMonth) === monthIndex;
                } else if (row['Audit Date']) {
                    const dt = parseDateFromString(row['Audit Date']);
                    if (dt && !isNaN(dt.getTime())) matchesMonth = dt.getMonth() === monthIndex;
                }
                const matchesType = (row.Tipo === 'INTERNA' || !row.Tipo);
                const matchesFactory = selectedFactory === 'all' || row['Factory Code'] === selectedFactory;
                const matchesCustomer = (!selectedChartCustomers || selectedChartCustomers.length === 0) || selectedChartCustomers.includes(row['Customer']);
                return matchesMonth && matchesType && matchesFactory && matchesCustomer;
            });

            if (!rows || rows.length === 0) {
                console.log('No rows for month', monthNumber, 'using sample fallback');
                const sample = {7:3.71,8:2.91,9:3.16,10:4.22,11:4.22,12:3.01};
                return sample[monthNumber] || 0;
            }

            let totalDefects = 0;
            let totalSampleSize = 0;
            rows.forEach(row => {
                const defects = parseFloat(row['Tot. Def.']) || parseFloat(row['Tot.    Def.']) || parseFloat(row['Tot Def']) || 0;
                const sampleSize = parseFloat(row['Sample Size']) || parseFloat(row['Sample    Size']) || parseFloat(row['SampleSize']) || 0;
                totalDefects += defects;
                totalSampleSize += sampleSize;
            });

            const defectivePercentage = totalSampleSize > 0 ? (totalDefects / totalSampleSize * 100) : 0;
            return Math.round(defectivePercentage * 100) / 100;
        }

        // Funci√≥n para obtener BAP por mes (mesNumber 1..12)
        function getBAPForMonth(monthNumber, selectedFactory = 'all') {
            console.log('Getting BAP data for month:', monthNumber, 'factory:', selectedFactory);
            const monthIndex = parseInt(monthNumber,10) - 1;

            if (!gridData || gridData.length === 0) {
                const sampleBAP = {7:86,8:84,9:89,10:86,11:68,12:80};
                return sampleBAP[monthNumber] || 0;
            }

            const selectedChartCustomers = arguments.length > 2 && Array.isArray(arguments[2]) ? arguments[2] : [];
            const rows = gridData.filter(row => {
                let matchesMonth = false;
                if (row._auditMonth !== undefined && row._auditMonth !== null) {
                    matchesMonth = Number(row._auditMonth) === monthIndex;
                } else if (row['Audit Date']) {
                    const dt = parseDateFromString(row['Audit Date']);
                    if (dt && !isNaN(dt.getTime())) matchesMonth = dt.getMonth() === monthIndex;
                }
                const matchesType = (row.Tipo === 'INTERNA' || !row.Tipo);
                const matchesFactory = selectedFactory === 'all' || row['Factory Code'] === selectedFactory;
                const matchesCustomer = (!selectedChartCustomers || selectedChartCustomers.length === 0) || selectedChartCustomers.includes(row['Customer']);
                return matchesMonth && matchesType && matchesFactory && matchesCustomer;
            });

            if (!rows || rows.length === 0) {
                const sampleBAP = {7:86,8:84,9:89,10:86,11:68,12:80};
                return sampleBAP[monthNumber] || 0;
            }

            let intentoOnes = 0;
            let intentoAny = 0;
            rows.forEach(r => {
                const intentoRaw = r['Intento'];
                if (intentoRaw !== '' && intentoRaw !== null && intentoRaw !== undefined) {
                    intentoAny++;
                    const intentoNum = parseInt(String(intentoRaw).trim());
                    if (!isNaN(intentoNum) && intentoNum === 1) intentoOnes++;
                }
            });
            if (intentoAny === 0) return 0;
            const bap = (intentoOnes / intentoAny) * 100;
            return Math.round(bap);
        }

        // Funci√≥n para crear la gr√°fica de tendencias
        function createTrendsChart(data) {
            console.log('Creating chart with data:', data);
            console.log('BAP data array:', data.map(item => item.bap));
            
            // Usar los valores BAP calculados din√°micamente de los datos
            const bapValues = data.map(item => item.bap);
            console.log('Dynamic BAP values:', bapValues);
            
            // Calcular el m√°ximo valor de % Defectuosos para ajustar el eje Y
            const defectValues = data.map(item => item.defects);
            const maxDefectValue = Math.max(...defectValues);
            const yAxisMax = Math.ceil(maxDefectValue * 1.2); // Agregar 20% de padding arriba
            console.log('Max defect value:', maxDefectValue, 'Y-axis max:', yAxisMax);
            
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            // Destruir gr√°fica existente si existe
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            
            new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: data.map(item => item.week),
                    datasets: [{
                        label: '% Defectuosos',
                        data: data.map(item => item.defects),
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.1,
                        pointBackgroundColor: '#FF6B6B',
                        pointBorderColor: '#FF6B6B',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        type: 'line',
                        yAxisID: 'y',
                        order: 1
                    }, {
                        label: 'BAP (%)',
                        data: bapValues,
                        backgroundColor: 'rgba(74, 144, 226, 0.8)',
                        borderColor: '#4A90E2',
                        borderWidth: 2,
                        type: 'bar',
                        yAxisID: 'y1',
                        order: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                                    } else {
                                        return `${context.dataset.label}: ${context.parsed.y}%`;
                                    }
                                }
                            }
                        },
                        datalabels: {
                            display: true, // Mostrar etiquetas en ambos datasets
                            color: function(context) {
                                return context.datasetIndex === 0 ? '#000000' : '#003d82'; // Negro para l√≠nea, azul oscuro para barras
                            },
                            font: {
                                family: 'Calibri',
                                size: 16,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                if (context.datasetIndex === 0) {
                                    return value.toFixed(2) + '%';
                                }
                                return value + '%'; // Para BAP
                            },
                            anchor: function(context) {
                                return context.datasetIndex === 0 ? 'end' : 'end'; // L√≠nea: end, Barras: end
                            },
                            align: function(context) {
                                return context.datasetIndex === 0 ? 'bottom' : 'top'; // L√≠nea: debajo, Barras: arriba
                            },
                            offset: 8
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: 'Semanas',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '% Defectuosos',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            max: yAxisMax,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'BAP (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    elements: {
                        point: {
                            hoverRadius: 10
                        }
                    }
                }
            });
        }

        function downloadExcel() {
            if (!currentInternaData.length && !currentClienteData.length) {
                alert('No hay datos para descargar');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Crear hoja INTERNA con estilos
            createStyledSheet(wb, 'internaTable', 'INTERNA');
            
            // Crear hoja CLIENTE con estilos
            createStyledSheet(wb, 'clienteTable', 'CLIENTE');
            
            // Descargar archivo
            const selectedWeek = weekSelect.value || 'resumen';
            XLSX.writeFile(wb, `Resumen_Auditoria_Week_${selectedWeek}.xlsx`);
        }

        function createStyledSheet(wb, tableId, sheetName) {
            const table = document.getElementById(tableId);
            const ws = XLSX.utils.table_to_sheet(table);
            
            // Obtener el rango de la hoja
            let range = XLSX.utils.decode_range(ws['!ref']);
            
            // Asegurar que el rango incluya todas las columnas necesarias
            // Para INTERNA: hasta columna Y (√≠ndice 24), para CLIENTE: hasta U (√≠ndice 20)
            const maxCol = sheetName === 'INTERNA' ? 24 : 20;
            if (range.e.c < maxCol) {
                range.e.c = maxCol;
                ws['!ref'] = XLSX.utils.encode_range(range);
            }
            
            // Estilos base
            const headerStyle = {
                fill: { fgColor: { rgb: "4472C4" } },
                font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11 },
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };

            const cellStyle = {
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };

            const subtotalStyle = {
                fill: { fgColor: { rgb: "C6EFCE" } },
                font: { bold: true },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };

            const totalStyle = {
                fill: { fgColor: { rgb: "D9D9D9" } },
                font: { bold: true },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };
            
            // PRIMERO: Crear todas las celdas del rango con bordes
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) {
                        ws[cellAddress] = { v: '', t: 's' };
                    }
                    // Aplicar estilo base con bordes a todas las celdas
                    ws[cellAddress].s = JSON.parse(JSON.stringify(cellStyle));
                }
            }

            // Aplicar estilos a las celdas
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    
                    const cellValue = ws[cellAddress].v;
                    
                    // Estilos para encabezados (primera fila)
                    if (R === 0) {
                        ws[cellAddress].s = headerStyle;
                    } else {
                        // Detectar filas especiales
                        if (C === 0 && typeof cellValue === 'string') {
                            if (cellValue.startsWith('Total ')) {
                                // Fila de subtotal
                                for (let col = 0; col <= range.e.c; col++) {
                                    const addr = XLSX.utils.encode_cell({ r: R, c: col });
                                    ws[addr].s = JSON.parse(JSON.stringify(subtotalStyle));
                                }
                            } else if (cellValue === 'Total general') {
                                // Fila Total general
                                for (let col = 0; col <= range.e.c; col++) {
                                    const addr = XLSX.utils.encode_cell({ r: R, c: col });
                                    ws[addr].s = JSON.parse(JSON.stringify(totalStyle));
                                }
                            } else if (cellValue === 'DEFECTUOSO') {
                                // Fila DEFECTUOSO - aplicar formato porcentaje con 2 decimales desde columna E (√≠ndice 4) hasta T (√≠ndice 19)
                                for (let col = 0; col <= range.e.c; col++) {
                                    const addr = XLSX.utils.encode_cell({ r: R, c: col });
                                    ws[addr].s = JSON.parse(JSON.stringify(totalStyle));
                                    // Aplicar formato porcentaje con 2 decimales solo desde columna E (4) hasta T (19)
                                    if (col >= 4 && col <= 19) {
                                        let cellVal = ws[addr].v !== undefined ? ws[addr].v : 0;
                                        // Convertir tanto strings como n√∫meros
                                        if (typeof cellVal === 'string') {
                                            // Si tiene %, quitar el s√≠mbolo
                                            cellVal = cellVal.replace('%', '').trim();
                                        }
                                        // Convertir a n√∫mero
                                        let numValue = parseFloat(cellVal);
                                        if (isNaN(numValue)) numValue = 0;
                                        ws[addr].v = numValue;
                                        ws[addr].t = 'n';
                                        ws[addr].s.numFmt = '0.00%';
                                    }
                                    // Para INTERNA: Columna V (√≠ndice 21) - formato % sin decimales
                                    else if (col === 21 && sheetName === 'INTERNA') {
                                        let cellVal = ws[addr].v !== undefined ? ws[addr].v : 0;
                                        if (typeof cellVal === 'string') {
                                            cellVal = cellVal.replace('%', '').trim();
                                        }
                                        let numValue = parseFloat(cellVal);
                                        if (isNaN(numValue)) numValue = 0;
                                        ws[addr].v = numValue;
                                        ws[addr].t = 'n';
                                        ws[addr].s.numFmt = '0%';
                                    }
                                }
                            }
                        } else if (R > 0) {
                            // Detectar la √∫ltima fila (siguiente despu√©s de DEFECTUOSO)
                            const prevRowFirstCell = XLSX.utils.encode_cell({ r: R - 1, c: 0 });
                            if (ws[prevRowFirstCell] && ws[prevRowFirstCell].v === 'DEFECTUOSO') {
                                // √öltima fila - formato porcentaje sin decimales desde columna D (√≠ndice 3) hasta T (√≠ndice 19)
                                for (let col = 0; col <= range.e.c; col++) {
                                    const addr = XLSX.utils.encode_cell({ r: R, c: col });
                                    // Aplicar formato porcentaje sin decimales solo desde columna D (3) hasta T (19)
                                    if (col >= 3 && col <= 19) {
                                        let cellVal = ws[addr].v !== undefined ? ws[addr].v : 0;
                                        // Convertir tanto strings como n√∫meros
                                        if (typeof cellVal === 'string') {
                                            // Si tiene %, quitar el s√≠mbolo
                                            cellVal = cellVal.replace('%', '').trim();
                                        }
                                        // Convertir a n√∫mero
                                        let numValue = parseFloat(cellVal);
                                        if (isNaN(numValue)) numValue = 0;
                                        ws[addr].v = numValue;
                                        ws[addr].t = 'n';
                                        ws[addr].s.numFmt = '0%';
                                    }
                                    // Para INTERNA: Columna V (√≠ndice 21) - formato % sin decimales
                                    else if (col === 21 && sheetName === 'INTERNA') {
                                        let cellVal = ws[addr].v !== undefined ? ws[addr].v : 0;
                                        if (typeof cellVal === 'string') {
                                            cellVal = cellVal.replace('%', '').trim();
                                        }
                                        let numValue = parseFloat(cellVal);
                                        if (isNaN(numValue)) numValue = 0;
                                        ws[addr].v = numValue;
                                        ws[addr].t = 'n';
                                        ws[addr].s.numFmt = '0%';
                                    }
                                }
                            }
                        }
                        
                        
                        // Hacer que los ceros tengan color blanco en filas de datos normales (no totales, no DEFECTUOSO) columnas E a Y (√≠ndices 4 a 24)
                        const firstCellAddr = XLSX.utils.encode_cell({ r: R, c: 0 });
                        const firstCellValue = ws[firstCellAddr] ? ws[firstCellAddr].v : '';
                        const isDataRow = firstCellValue && 
                                         typeof firstCellValue === 'string' && 
                                         !firstCellValue.startsWith('Total') && 
                                         firstCellValue !== 'Total general' && 
                                         firstCellValue !== 'DEFECTUOSO';
                        
                        if (isDataRow && C >= 4 && C <= 24) {
                            if (ws[cellAddress].v === 0 || ws[cellAddress].v === '0') {
                                // En lugar de eliminar el contenido, poner el texto en color blanco
                                if (!ws[cellAddress].s.font) {
                                    ws[cellAddress].s.font = {};
                                }
                                ws[cellAddress].s.font.color = { rgb: "FFFFFF" };
                            }
                        }
                    }
                }
            }
            
            // Ajustar anchos de columna
            const colWidths = [];
            // Definir columnas especiales con ancho 7.33: D(3), G(6), J(9), K(10), L(11), M(12), N(13), P(15), R(17), U(20)
            const colsWith733 = [3, 6, 9, 10, 11, 12, 13, 15, 17, 20];
            
            for (let C = 0; C <= range.e.c; ++C) {
                if (C < 2) {
                    colWidths.push({ wch: 15 }); // Factory Code y Customer
                } else if (colsWith733.includes(C)) {
                    colWidths.push({ wch: 7.33 }); // Columnas D, G, J, K, L, M, N, P, R, U
                } else if (C >= 2 && C <= 20) {
                    colWidths.push({ wch: 6 }); // Resto de columnas C a U (√≠ndices 2 a 20)
                } else if (C >= 21 && C <= 24 && sheetName === 'INTERNA') {
                    colWidths.push({ wch: 4.5 }); // Columnas V, W, X, Y (√≠ndices 21-24) solo para INTERNA
                } else {
                    colWidths.push({ wch: 12 }); // Resto
                }
            }
            ws['!cols'] = colWidths;
            
            // Para CLIENTE: eliminar columnas V, W, X (√≠ndices 21, 22, 23)
            if (sheetName === 'CLIENTE') {
                // Eliminar celdas de las columnas V, W, X
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = 21; C <= 23; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        delete ws[cellAddress];
                    }
                }
                // Ajustar el rango para terminar en columna U (√≠ndice 20)
                range.e.c = 20;
                ws['!ref'] = XLSX.utils.encode_range(range);
                // Ajustar anchos de columna
                ws['!cols'] = colWidths.slice(0, 21);
            }
            
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }

        // Initialize the application by loading data from Google Sheets
        function initializeApp() {
            updateLoadingStatus('Cargando datos desde Google Sheets...', 'loading');
            btnDownload.disabled = true; // Asegurar que est√© deshabilitado durante la carga
            btnChart.disabled = true; // Asegurar que est√© deshabilitado durante la carga
            
            loadSheetJSONP(SHEET_ID, SHEET_NAME)
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Los datos recibidos no tienen el formato esperado.');
                    }
                    
                    if (data.length === 0) {
                        throw new Error('La hoja de c√°lculo est√° vac√≠a o no contiene datos.');
                    }
                    
                    processSheetData(data);
                })
                .catch(error => {
                    console.error('Error al cargar datos:', error);
                    updateLoadingStatus('Error al cargar datos: ' + error.message, 'error');
                    showError('No se pudieron cargar los datos desde Google Sheets. Verifique que la hoja sea p√∫blica y tenga el nombre correcto.');
                    btnDownload.disabled = true; // Mantener deshabilitado en caso de error
                    btnChart.disabled = true; // Mantener deshabilitado en caso de error
                });
        }

        // Start the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
